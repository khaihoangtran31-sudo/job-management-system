import React, { useState, useEffect, useMemo, useCallback } from 'react';
import './App.css';

// API Client - T·ª± ƒë·ªông detect IP m√°y ch·ªß v·ªõi fallback
const getApiBase = () => {
  // N·∫øu ƒëang ch·∫°y tr√™n localhost, s·ª≠ d·ª•ng localhost
  if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    return 'http://localhost:5001';
  }
  // N·∫øu truy c·∫≠p t·ª´ IP kh√°c, s·ª≠ d·ª•ng IP ƒë√≥
  const apiUrl = `http://${window.location.hostname}:5001`;
  console.log('üîç API Base URL:', apiUrl);
  return apiUrl;
};

// Danh s√°ch c√°c URL ƒë·ªÉ th·ª≠ k·∫øt n·ªëi
const getApiUrls = () => {
  const hostname = window.location.hostname;
  const urls = [];
  
  // N·∫øu ƒëang tr√™n localhost
  if (hostname === 'localhost' || hostname === '127.0.0.1') {
    urls.push('http://localhost:5001');
    urls.push('http://127.0.0.1:5001');
  } else {
    // N·∫øu ƒëang tr√™n IP kh√°c, th·ª≠ IP ƒë√≥ tr∆∞·ªõc
    urls.push(`http://${hostname}:5001`);
    urls.push('http://localhost:5001');
    urls.push('http://127.0.0.1:5001');
  }
  
  return urls;
};

const API_BASE = getApiBase();

const apiClient = {
  async request(endpoint, options = {}) {
    const urlsToTry = getApiUrls();
    
    for (const baseUrl of urlsToTry) {
      try {
        const url = `${baseUrl}${endpoint}`;
        const config = {
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          },
          ...options
        };

        console.log(`üîç Th·ª≠ k·∫øt n·ªëi ƒë·∫øn: ${url}`);
        const response = await fetch(url, config);
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || `HTTP ${response.status}`);
        }

        // N·∫øu th√†nh c√¥ng, c·∫≠p nh·∫≠t API_BASE cho c√°c request ti·∫øp theo
        if (baseUrl !== API_BASE) {
          window.API_BASE = baseUrl;
          console.log(`‚úÖ ƒê√£ c·∫≠p nh·∫≠t API_BASE th√†nh: ${baseUrl}`);
        }

        return data;
      } catch (error) {
        console.log(`‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn ${baseUrl}:`, error.message);
        // Ti·∫øp t·ª•c th·ª≠ URL ti·∫øp theo
        continue;
      }
    }
    
    // N·∫øu t·∫•t c·∫£ URL ƒë·ªÅu th·∫•t b·∫°i
    throw new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.');
  },

  async login(username, password) {
    try {
      const response = await this.request('/api/login', {
        method: 'POST',
        body: JSON.stringify({ username, password })
      });
      return response;
    } catch (error) {
      return { success: false, error: 'Kh√¥ng th·ªÉ k·∫øt n·ªëi server' };
    }
  },

  async getUsers() {
    try {
      const response = await this.request('/api/users');
      return response.data || [];
    } catch (error) {
      console.error('‚ùå L·ªói khi l·∫•y users:', error);
    return [];
    }
  },

  async updateUsers(users) {
    try {
      const response = await this.request('/api/users', {
        method: 'POST',
        body: JSON.stringify({ users })
      });
      return response.success;
    } catch (error) {
      console.error('‚ùå L·ªói khi c·∫≠p nh·∫≠t users:', error);
        return false;
      }
  },

  async getJobs() {
    try {
      const response = await this.request('/api/jobs');
      return response.data || [];
    } catch (error) {
      console.error('‚ùå L·ªói khi l·∫•y jobs:', error);
    return [];
    }
  },

  async updateJobs(jobs) {
    try {
      const response = await this.request('/api/jobs', {
        method: 'POST',
        body: JSON.stringify({ jobs })
      });
      return response.success;
    } catch (error) {
      console.error('‚ùå L·ªói khi c·∫≠p nh·∫≠t jobs:', error);
        return false;
      }
      }
};

function App() {
  // Authentication state
  const [currentUser, setCurrentUser] = useState(null);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [loginError, setLoginError] = useState('');
  
  // Network detection state
  const [networkInfo, setNetworkInfo] = useState(null);
  const [connectionStatus, setConnectionStatus] = useState('checking');
  
  // Data state
  const [users, setUsers] = useState([]);
  const [jobs, setJobs] = useState([]);
  const [activeTab, setActiveTab] = useState('list');
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState('');

  // Network detection functions
  const checkNetworkConnection = useCallback(async () => {
    try {
      setConnectionStatus('checking');
      const urlsToTry = getApiUrls();
      
      for (const url of urlsToTry) {
        try {
          console.log(`üîç ƒêang th·ª≠ k·∫øt n·ªëi ƒë·∫øn: ${url}`);
          const response = await fetch(`${url}/api/health`, {
            method: 'GET',
            timeout: 5000
          });
          
          if (response.ok) {
            const data = await response.json();
            setConnectionStatus('connected');
            setNetworkInfo({
              serverUrl: url,
              status: 'connected',
              timestamp: new Date().toISOString()
            });
            
            // C·∫≠p nh·∫≠t API_BASE
            window.API_BASE = url;
            console.log(`‚úÖ K·∫øt n·ªëi th√†nh c√¥ng ƒë·∫øn: ${url}`);
            return;
          }
        } catch (error) {
          console.log(`‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn ${url}:`, error.message);
          continue;
        }
      }
      
      // N·∫øu t·∫•t c·∫£ ƒë·ªÅu th·∫•t b·∫°i
      setConnectionStatus('disconnected');
      setNetworkInfo({
        serverUrl: null,
        status: 'disconnected',
        timestamp: new Date().toISOString()
      });
    } catch (error) {
      console.error('‚ùå L·ªói ki·ªÉm tra k·∫øt n·ªëi:', error);
      setConnectionStatus('error');
    }
  }, []);

  // Authentication functions
  const handleLogin = async (username, password) => {
    try {
      setLoginError('');
      const response = await apiClient.login(username, password);
      if (response.success) {
        setCurrentUser(response.user);
        setIsAuthenticated(true);
        localStorage.setItem('currentUser', JSON.stringify(response.user));
        console.log('‚úÖ ƒêƒÉng nh·∫≠p th√†nh c√¥ng:', response.user.fullName);
      } else {
        setLoginError(response.error || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i');
      }
    } catch (error) {
      console.error('‚ùå L·ªói ƒëƒÉng nh·∫≠p:', error);
      setLoginError('Kh√¥ng th·ªÉ k·∫øt n·ªëi server. Vui l√≤ng th·ª≠ l·∫°i.');
    }
  };

  const handleLogout = () => {
    setCurrentUser(null);
    setIsAuthenticated(false);
    setLoginError('');
    localStorage.removeItem('currentUser');
  };

  // Load users
  const loadUsers = useCallback(async () => {
    try {
      const usersData = await apiClient.getUsers();
      if (Array.isArray(usersData)) {
        setUsers(usersData);
        console.log('‚úÖ ƒê√£ t·∫£i users:', usersData.length, 'users');
      } else {
        setUsers([]);
      }
      } catch (error) {
        console.error('‚ùå L·ªói khi t·∫£i users:', error);
      setUsers([]);
    }
  }, []);

  // Ki·ªÉm tra k·∫øt n·ªëi khi component mount
  useEffect(() => {
    checkNetworkConnection();
  }, [checkNetworkConnection]);

  // Load jobs
  const loadJobs = useCallback(async () => {
    try {
      const jobsData = await apiClient.getJobs();
      if (Array.isArray(jobsData)) {
        setJobs(jobsData);
        console.log('‚úÖ ƒê√£ t·∫£i jobs:', jobsData.length, 'jobs');
      } else {
        setJobs([]);
      }
    } catch (error) {
      console.error('‚ùå L·ªói khi t·∫£i jobs:', error);
      setJobs([]);
    }
  }, []);

  // Update users
  const handleUpdateUsers = async (updatedUsers) => {
    try {
      setUsers(updatedUsers);
      await apiClient.updateUsers(updatedUsers);
      console.log('‚úÖ ƒê√£ c·∫≠p nh·∫≠t users');
    } catch (error) {
      console.error('‚ùå L·ªói khi c·∫≠p nh·∫≠t users:', error);
    }
  };

  // Update jobs
  const handleUpdateJobs = async (updatedJobs) => {
    try {
    setJobs(updatedJobs);
      await apiClient.updateJobs(updatedJobs);
      console.log('‚úÖ ƒê√£ c·∫≠p nh·∫≠t jobs');
    } catch (error) {
      console.error('‚ùå L·ªói khi c·∫≠p nh·∫≠t jobs:', error);
    }
  };

  // Check authentication on load
  useEffect(() => {
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
      try {
        const user = JSON.parse(savedUser);
        setCurrentUser(user);
        setIsAuthenticated(true);
        console.log('‚úÖ ƒê√£ kh√¥i ph·ª•c phi√™n ƒëƒÉng nh·∫≠p:', user.fullName);
      } catch (error) {
        localStorage.removeItem('currentUser');
      }
    }
  }, []);

  // Ki·ªÉm tra quy·ªÅn truy c·∫≠p tab khi user thay ƒë·ªïi
  useEffect(() => {
    if (currentUser) {
      // N·∫øu user kh√¥ng c√≥ quy·ªÅn truy c·∫≠p tab hi·ªán t·∫°i, chuy·ªÉn v·ªÅ tab m·∫∑c ƒë·ªãnh
      const hasAccessToCurrentTab = () => {
        switch (activeTab) {
          case 'dashboard':
          case 'salary':
            return currentUser.role === 'admin' || currentUser.position === 'T·ªï tr∆∞·ªüng';
          case 'users':
            return currentUser.role === 'admin';
          case 'list':
          default:
            return true; // T·∫•t c·∫£ user ƒë·ªÅu c√≥ quy·ªÅn truy c·∫≠p tab c√¥ng vi·ªác
        }
      };

      if (!hasAccessToCurrentTab()) {
        setActiveTab('list');
      }
    }
  }, [currentUser, activeTab]);

  // Test server connection with fallback
  const testServerConnection = useCallback(async () => {
    const urlsToTry = [
      API_BASE,
      'http://localhost:5001',
      `http://${window.location.hostname}:5001`
    ];
    
    for (const url of urlsToTry) {
      try {
        console.log(`üîç ƒêang th·ª≠ k·∫øt n·ªëi ƒë·∫øn: ${url}`);
        const response = await fetch(`${url}/api/health`, {
          method: 'GET',
          timeout: 5000
        });
        
        if (response.ok) {
          const data = await response.json();
          console.log('‚úÖ Server ƒëang ho·∫°t ƒë·ªông:', data);
          // Update API_BASE to working URL
          if (url !== API_BASE) {
            console.log(`üîÑ C·∫≠p nh·∫≠t API_BASE t·ª´ ${API_BASE} th√†nh ${url}`);
            window.API_BASE = url;
          }
          return true;
        }
      } catch (error) {
        console.log(`‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn ${url}:`, error.message);
        continue;
      }
    }
    
    console.error('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server t·ª´ b·∫•t k·ª≥ URL n√†o');
    return false;
  }, []);

  // Load data on mount
  useEffect(() => {
    if (isAuthenticated) {
      loadUsers();
      loadJobs();
      // Test server connection on mount
      testServerConnection();
    }
  }, [isAuthenticated, testServerConnection]);

  // Keyboard shortcuts
  useEffect(() => {
    const handleKeyPress = (e) => {
      if (!isAuthenticated) return;
      
      // Ctrl/Cmd + N: Th√™m c√¥ng vi·ªác m·ªõi
      if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        if (currentUser?.role === 'admin' || currentUser?.position === 'T·ªï tr∆∞·ªüng') {
          setIsAdding(true);
        }
      }
      
      // Ctrl/Cmd + F: Focus v√†o √¥ t√¨m ki·∫øm
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        const searchInput = document.querySelector('.filter-input');
        if (searchInput) searchInput.focus();
      }
      
      // Escape: ƒê√≥ng form th√™m/s·ª≠a
      if (e.key === 'Escape') {
        setIsAdding(false);
        setEditingUser(null);
      }
    };

    document.addEventListener('keydown', handleKeyPress);
    return () => document.removeEventListener('keydown', handleKeyPress);
  }, [isAuthenticated, currentUser]);

  // T·ª± ƒë·ªông ki·ªÉm tra v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i c√¥ng vi·ªác tr·ªÖ h·∫°n
  useEffect(() => {
    if (isAuthenticated && jobs.length > 0) {
      checkAndUpdateOverdueJobs();
    }
  }, [isAuthenticated, jobs]);

  // Ki·ªÉm tra deadline v√† hi·ªÉn th·ªã th√¥ng b√°o nh·∫Øc nh·ªü
  const getUpcomingDeadlines = () => {
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);
    
    return jobs.filter(job => {
      if (!job.completionTime || job.status === 'th√†nh c√¥ng') return false;
      
      // L·ªçc theo b·ªô ph·∫≠n c·ªßa ng∆∞·ªùi d√πng hi·ªán t·∫°i
      if (currentUser?.role !== 'admin' && job.department !== currentUser?.department) {
        return false;
      }
      
      const completionDate = new Date(job.completionTime);
      const timeDiff = completionDate.getTime() - today.getTime();
      const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
      
      // Nh·∫Øc nh·ªü tr∆∞·ªõc 1 ng√†y (0-1 ng√†y)
      return daysDiff >= 0 && daysDiff <= 1;
    });
  };

  // H√†m ki·ªÉm tra v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i c√¥ng vi·ªác tr·ªÖ h·∫°n
  const checkAndUpdateOverdueJobs = () => {
    const today = new Date();
    const overdueJobs = [];
    
    const updatedJobs = jobs.map(job => {
      // Ch·ªâ c·∫≠p nh·∫≠t n·∫øu c√¥ng vi·ªác ch∆∞a ho√†n th√†nh v√† c√≥ ng√†y ho√†n th√†nh
      if (job.status !== 'th√†nh c√¥ng' && job.status !== 'th·∫•t b·∫°i' && job.completionTime) {
        const completionDate = new Date(job.completionTime);
        const timeDiff = completionDate.getTime() - today.getTime();
        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
        
        // N·∫øu tr·ªÖ h·∫°n (ng√†y ho√†n th√†nh ƒë√£ qua)
        if (daysDiff < 0) {
          overdueJobs.push(job);
          return { ...job, status: 'th·∫•t b·∫°i' };
        }
      }
      return job;
    });
    
    // C·∫≠p nh·∫≠t danh s√°ch c√¥ng vi·ªác n·∫øu c√≥ thay ƒë·ªïi
    const hasChanges = updatedJobs.some((job, index) => job.status !== jobs[index].status);
    if (hasChanges) {
      handleUpdateJobs(updatedJobs);
      
      // Hi·ªÉn th·ªã th√¥ng b√°o v·ªÅ c√°c c√¥ng vi·ªác tr·ªÖ h·∫°n
      if (overdueJobs.length > 0) {
        const overdueList = overdueJobs.map(job => `‚Ä¢ ${job.description} (${job.department})`).join('\n');
        alert(`‚ö†Ô∏è C·∫¢NH B√ÅO: ${overdueJobs.length} c√¥ng vi·ªác ƒë√£ tr·ªÖ h·∫°n v√† ƒë∆∞·ª£c t·ª± ƒë·ªông c·∫≠p nh·∫≠t th√†nh "th·∫•t b·∫°i":\n\n${overdueList}`);
      }
    }
  };

  const upcomingDeadlines = getUpcomingDeadlines();

  // Reminder Notification Component
  const ReminderNotification = ({ deadlines }) => {
    if (deadlines.length === 0) return null;

    const getReminderMessage = (job) => {
      const today = new Date();
      const completionDate = new Date(job.completionTime);
      const timeDiff = completionDate.getTime() - today.getTime();
      const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
      
      if (daysDiff === 0) {
        return `‚ö†Ô∏è H√¥m nay l√† deadline: "${job.description}"`;
      } else if (daysDiff === 1) {
        return `‚è∞ Ng√†y mai deadline: "${job.description}"`;
      }
      return `üìÖ C√≤n ${daysDiff} ng√†y: "${job.description}"`;
    };

    return (
      <div className="reminder-notification">
        <div className="reminder-header">
          <h3>üîî Nh·∫Øc nh·ªü deadline</h3>
          <span className="reminder-count">
            {deadlines.length} c√¥ng vi·ªác
            {currentUser?.role !== 'admin' && (
              <span className="department-info"> (B·ªô ph·∫≠n: {currentUser?.department})</span>
            )}
          </span>
        </div>
        <div className="reminder-list">
          {deadlines.map(job => (
            <div key={job.id} className="reminder-item">
              <div className="reminder-message">
                {getReminderMessage(job)}
              </div>
              <div className="reminder-details">
                <span className="reminder-department">üè¢ {job.department}</span>
                <span className="reminder-assignee">üë§ {job.assigner || 'Ch∆∞a giao'} ‚Üí {job.assignee || 'Ch∆∞a giao'}</span>
                <span className="reminder-date">üìÖ {new Date(job.completionTime).toLocaleDateString('vi-VN')}</span>
                <span className={`reminder-status status-${job.status}`}>
                  {job.status === 'nh·∫≠n vi·ªác' ? 'üìã Nh·∫≠n vi·ªác' :
                   job.status === 'ƒëang x·ª≠ l√Ω' ? '‚è≥ ƒêang x·ª≠ l√Ω' :
                   job.status === 'ch·ªù duy·ªát' ? '‚è∏Ô∏è Ch·ªù duy·ªát' :
                   job.status === 'th·∫•t b·∫°i' ? '‚ùå Th·∫•t b·∫°i' : '‚úÖ Th√†nh c√¥ng'}
                </span>
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  };

  // Login Form Component
  const LoginForm = () => {
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');

    const handleSubmit = (e) => {
      e.preventDefault();
      if (username && password) {
        handleLogin(username, password);
      } else {
        setLoginError('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin');
      }
    };

    const getConnectionStatusIcon = () => {
      switch (connectionStatus) {
        case 'connected':
          return 'üü¢';
        case 'checking':
          return 'üü°';
        case 'disconnected':
          return 'üî¥';
        default:
          return '‚ö™';
      }
    };

    const getConnectionStatusText = () => {
      switch (connectionStatus) {
        case 'connected':
          return `ƒê√£ k·∫øt n·ªëi ƒë·∫øn server`;
        case 'checking':
          return 'ƒêang ki·ªÉm tra k·∫øt n·ªëi...';
        case 'disconnected':
          return 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server';
        default:
          return 'Tr·∫°ng th√°i kh√¥ng x√°c ƒë·ªãnh';
      }
    };

    return (
      <div className="login-container">
        <div className="login-form">
          <h2>üîê ƒêƒÉng nh·∫≠p h·ªá th·ªëng</h2>
          
          {/* Network Status */}
          <div className="network-status">
            <div className="status-indicator">
              {getConnectionStatusIcon()} {getConnectionStatusText()}
            </div>
            {networkInfo && networkInfo.serverUrl && (
              <div className="server-info">
                üì° Server: {networkInfo.serverUrl}
              </div>
            )}
            {connectionStatus === 'disconnected' && (
              <div className="connection-help">
                <p>üí° H∆∞·ªõng d·∫´n k·∫øt n·ªëi:</p>
                <ul>
                  <li>Ki·ªÉm tra server ƒë√£ kh·ªüi ƒë·ªông ch∆∞a</li>
                  <li>Ki·ªÉm tra k·∫øt n·ªëi m·∫°ng</li>
                  <li>Th·ª≠ truy c·∫≠p t·ª´ IP kh√°c trong m·∫°ng LAN</li>
                </ul>
                <button 
                  onClick={checkNetworkConnection}
                  className="retry-btn"
                >
                  üîÑ Th·ª≠ k·∫øt n·ªëi l·∫°i
                </button>
              </div>
            )}
          </div>
          
          <form onSubmit={handleSubmit}>
            <div className="form-group">
              <label>T√™n ƒëƒÉng nh·∫≠p:</label>
              <input
                type="text"
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                placeholder="Nh·∫≠p username"
                required
                disabled={connectionStatus === 'disconnected'}
              />
            </div>
            <div className="form-group">
              <label>M·∫≠t kh·∫©u:</label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="Nh·∫≠p password"
                required
                disabled={connectionStatus === 'disconnected'}
              />
            </div>
            
            {loginError && (
              <div className="error-message">
                ‚ùå {loginError}
              </div>
            )}
            <button 
              type="submit" 
              className="login-btn"
              disabled={connectionStatus === 'disconnected'}
            >
              üöÄ ƒêƒÉng nh·∫≠p
            </button>
          </form>
        </div>
      </div>
    );
  };

  // Main App Component
  const MainApp = () => {
  return (
    <div className="App">
      <div className="container">
        <header className="header">
          <div className="header-content">
            <div className="header-info">
              <h1>üìã Danh s√°ch vi·ªác l√†m</h1>
              <p>Qu·∫£n l√Ω v√† theo d√µi ti·∫øn ƒë·ªô c√¥ng vi·ªác</p>
            </div>
            <div className="user-info">
              <div className="user-details">
                  <span className="user-name">{currentUser?.fullName}</span>
                  <span className="user-department">{currentUser?.department}</span>
                  <span className="user-position">{currentUser?.position}</span>
              </div>
            <div className="user-actions">
                  <button onClick={handleLogout} className="logout-btn">
                    üö™ ƒêƒÉng xu·∫•t
                  </button>
            </div>
            </div>
          </div>
        </header>

        <div className="tab-navigation">
          <button 
            className={`tab-btn ${activeTab === 'list' ? 'active' : ''}`}
            onClick={() => setActiveTab('list')}
            title="Ctrl+F: T√¨m ki·∫øm, Ctrl+N: Th√™m m·ªõi"
          >
            üìã Qu·∫£n l√Ω c√¥ng vi·ªác
          </button>
          
          {/* Dashboard - Admin, Qu·∫£n l√Ω, T·ªï tr∆∞·ªüng */}
          {(currentUser?.role === 'admin' || currentUser?.position === 'Qu·∫£n l√Ω' || currentUser?.position === 'T·ªï tr∆∞·ªüng') && (
            <button 
              className={`tab-btn ${activeTab === 'dashboard' ? 'active' : ''}`}
              onClick={() => setActiveTab('dashboard')}
            >
              üìä Dashboard & Th·ªëng k√™
            </button>
          )}
          
          {/* KPI Evaluation - Admin, Qu·∫£n l√Ω, T·ªï tr∆∞·ªüng, T·ªï ph√≥ */}
          {(currentUser?.role === 'admin' || currentUser?.position === 'Qu·∫£n l√Ω' || currentUser?.position === 'T·ªï tr∆∞·ªüng' || currentUser?.position === 'T·ªï ph√≥') && (
            <button 
              className={`tab-btn ${activeTab === 'salary' ? 'active' : ''}`}
              onClick={() => setActiveTab('salary')}
            >
              üìä ƒê√°nh gi√° KPI nh√¢n s·ª±
            </button>
          )}
          
          {/* User Management - Ch·ªâ admin */}
          {currentUser?.role === 'admin' && (
            <button 
              className={`tab-btn ${activeTab === 'users' ? 'active' : ''}`}
              onClick={() => setActiveTab('users')}
            >
              üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng
            </button>
          )}
        </div>

        <div className="tab-content">
        {/* Hi·ªÉn th·ªã th√¥ng b√°o nh·∫Øc nh·ªü ·ªü ƒë·∫ßu m·ªçi tab */}
        <ReminderNotification deadlines={upcomingDeadlines} />
        
        {activeTab === 'list' && (
            <JobManagement 
              jobs={jobs}
              onUpdateJobs={handleUpdateJobs}
              currentUser={currentUser}
            />
        )}

        {activeTab === 'dashboard' && (
          <Dashboard 
            jobs={jobs}
              users={users}
            currentUser={currentUser}
          />
        )}

          {activeTab === 'salary' && (
            <KPIEvaluation 
              users={users}
              jobs={jobs}
            currentUser={currentUser}
          />
        )}

        {activeTab === 'users' && (
            <UserManagement 
            users={users}
            onUpdateUsers={handleUpdateUsers}
            currentUser={currentUser}
          />
        )}

      </div>
        </div>
      </div>
    );
  };

  // Dashboard Component
  const Dashboard = ({ jobs, users, currentUser }) => {
    const [timeFilter, setTimeFilter] = useState('all'); // all, week, month, quarter, year
    const [departmentFilter, setDepartmentFilter] = useState('all');
    const [refreshKey, setRefreshKey] = useState(0);
    const [isRefreshing, setIsRefreshing] = useState(false);
    const [autoRefresh, setAutoRefresh] = useState(true);
    
    // Auto refresh effect
    useEffect(() => {
      if (!autoRefresh) return;
      
      const interval = setInterval(() => {
        setRefreshKey(prev => prev + 1);
      }, 30000); // Refresh every 30 seconds
      
      return () => clearInterval(interval);
    }, [autoRefresh]);
    
    // Manual refresh function
    const handleRefresh = async () => {
      setIsRefreshing(true);
      setRefreshKey(prev => prev + 1);
      setTimeout(() => setIsRefreshing(false), 1000);
    };
    
    // Filter jobs by time period
    const getFilteredJobs = () => {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      
      let filteredJobs = jobs;
      
      // Filter by time period
      switch (timeFilter) {
        case 'today':
          filteredJobs = jobs.filter(job => {
            if (!job.deliveryDate) return false;
            const jobDate = new Date(job.deliveryDate);
            const jobDateOnly = new Date(jobDate.getFullYear(), jobDate.getMonth(), jobDate.getDate());
            return jobDateOnly.getTime() === today.getTime();
          });
          break;
        case 'week':
          const weekStart = new Date(today);
          weekStart.setDate(today.getDate() - today.getDay());
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekStart.getDate() + 6);
          filteredJobs = jobs.filter(job => {
            if (!job.deliveryDate) return false;
            const jobDate = new Date(job.deliveryDate);
            const jobDateOnly = new Date(jobDate.getFullYear(), jobDate.getMonth(), jobDate.getDate());
            return jobDateOnly >= weekStart && jobDateOnly <= weekEnd;
          });
          break;
          
        case 'month':
          const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
          const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
          filteredJobs = jobs.filter(job => {
            if (!job.deliveryDate) return false;
            const jobDate = new Date(job.deliveryDate);
            const jobDateOnly = new Date(jobDate.getFullYear(), jobDate.getMonth(), jobDate.getDate());
            return jobDateOnly >= monthStart && jobDateOnly <= monthEnd;
          });
          break;
          
        case 'quarter':
          const quarter = Math.floor(today.getMonth() / 3);
          const quarterStart = new Date(today.getFullYear(), quarter * 3, 1);
          const quarterEnd = new Date(today.getFullYear(), quarter * 3 + 3, 0);
          filteredJobs = jobs.filter(job => {
            if (!job.deliveryDate) return false;
            const jobDate = new Date(job.deliveryDate);
            const jobDateOnly = new Date(jobDate.getFullYear(), jobDate.getMonth(), jobDate.getDate());
            return jobDateOnly >= quarterStart && jobDateOnly <= quarterEnd;
          });
          break;
          
        case 'year':
          const yearStart = new Date(today.getFullYear(), 0, 1);
          const yearEnd = new Date(today.getFullYear(), 11, 31);
          filteredJobs = jobs.filter(job => {
            if (!job.deliveryDate) return false;
            const jobDate = new Date(job.deliveryDate);
            const jobDateOnly = new Date(jobDate.getFullYear(), jobDate.getMonth(), jobDate.getDate());
            return jobDateOnly >= yearStart && jobDateOnly <= yearEnd;
          });
          break;
          
        default:
          filteredJobs = jobs;
      }
      
      // Filter by department
      if (departmentFilter !== 'all') {
        filteredJobs = filteredJobs.filter(job => job.department === departmentFilter);
      }
      
      return filteredJobs;
    };

    const filteredJobs = getFilteredJobs();
    
    // Debug information
    console.log('Dashboard Filter Debug:', {
      timeFilter,
      departmentFilter,
      totalJobs: jobs.length,
      filteredJobs: filteredJobs.length,
      sampleJobs: jobs.slice(0, 3).map(job => ({
        id: job.id,
        deliveryDate: job.deliveryDate,
        department: job.department,
        status: job.status
      }))
    });
    
    const stats = {
      totalJobs: filteredJobs.length,
      completedJobs: filteredJobs.filter(job => job.status === 'th√†nh c√¥ng').length,
      pendingJobs: filteredJobs.filter(job => job.status === 'nh·∫≠n vi·ªác' || job.status === 'ƒëang x·ª≠ l√Ω' || job.status === 'ch·ªù duy·ªát').length,
      failedJobs: filteredJobs.filter(job => job.status === 'th·∫•t b·∫°i').length,
      totalUsers: users.length,
      activeUsers: users.filter(user => user.role !== 'inactive').length
    };

    const departmentStats = filteredJobs.reduce((acc, job) => {
      if (!acc[job.department]) {
        acc[job.department] = { 
          total: 0, 
          completed: 0, 
          pending: 0,
          failed: 0,
          inProgress: 0,
          waiting: 0,
          percentage: 0,
          avgCompletionTime: 0,
          onTimeRate: 0,
          overdue: 0
        };
      }
      
      acc[job.department].total += 1;
      
      // Count by status
      switch (job.status) {
        case 'th√†nh c√¥ng':
        acc[job.department].completed += 1;
          break;
        case 'nh·∫≠n vi·ªác':
        case 'ƒëang x·ª≠ l√Ω':
        case 'ch·ªù duy·ªát':
          acc[job.department].pending += 1;
          if (job.status === 'ƒëang x·ª≠ l√Ω') acc[job.department].inProgress += 1;
          if (job.status === 'ch·ªù duy·ªát') acc[job.department].waiting += 1;
          break;
        case 'th·∫•t b·∫°i':
          acc[job.department].failed += 1;
          break;
      }
      
      // Calculate completion time and overdue
      if (job.completionTime && job.deliveryDate) {
        const deliveryDate = new Date(job.deliveryDate);
        const completionDate = new Date(job.completionTime);
        const today = new Date();
        
        if (job.status === 'th√†nh c√¥ng') {
          const completionTime = Math.ceil((completionDate - deliveryDate) / (1000 * 60 * 60 * 24));
          acc[job.department].avgCompletionTime = (acc[job.department].avgCompletionTime + completionTime) / 2;
        }
        
        // Check if overdue
        if (job.status !== 'th√†nh c√¥ng' && job.status !== 'th·∫•t b·∫°i' && completionDate < today) {
          acc[job.department].overdue += 1;
        }
      }
      
      acc[job.department].percentage = Math.round((acc[job.department].completed / acc[job.department].total) * 100);
      acc[job.department].onTimeRate = Math.round(((acc[job.department].completed - acc[job.department].overdue) / acc[job.department].completed) * 100) || 0;
      
      return acc;
    }, {});

    const statusStats = filteredJobs.reduce((acc, job) => {
      acc[job.status] = (acc[job.status] || 0) + 1;
      return acc;
    }, {});

    return (
      <div className="dashboard">
        <div className="dashboard-header">
          <div className="header-content">
            <div className="header-text">
              <h2>üìä Dashboard & Th·ªëng k√™</h2>
              <p>Xin ch√†o {currentUser?.fullName}, ƒë√¢y l√† t·ªïng quan h·ªá th·ªëng</p>
              <div className="refresh-controls">
                <button 
                  className={`refresh-btn ${isRefreshing ? 'refreshing' : ''}`}
                  onClick={handleRefresh}
                  title="L√†m m·ªõi d·ªØ li·ªáu"
                >
                  {isRefreshing ? 'üîÑ' : 'üîÑ'} {isRefreshing ? 'ƒêang t·∫£i...' : 'L√†m m·ªõi'}
                </button>
                <label className="auto-refresh-toggle">
                  <input
                    type="checkbox"
                    checked={autoRefresh}
                    onChange={(e) => setAutoRefresh(e.target.checked)}
                  />
                  <span className="toggle-label">T·ª± ƒë·ªông c·∫≠p nh·∫≠t (30s)</span>
                </label>
              </div>
              <div className="filter-info">
                <span className="filter-badge">
                  üìÖ {timeFilter === 'all' ? 'T·∫•t c·∫£ th·ªùi gian' : 
                       timeFilter === 'week' ? 'Tu·∫ßn n√†y' :
                       timeFilter === 'month' ? 'Th√°ng n√†y' :
                       timeFilter === 'quarter' ? 'Qu√Ω n√†y' :
                       timeFilter === 'year' ? 'NƒÉm n√†y' : timeFilter}
                </span>
                {departmentFilter !== 'all' && (
                  <span className="filter-badge">
                    üè¢ {departmentFilter}
                  </span>
                )}
                <span className="filter-badge">
                  üìä {filteredJobs.length} c√¥ng vi·ªác
                </span>
              </div>
            </div>
            <div className="dashboard-filters">
              <div className="filter-group">
                <label>üìÖ Th·ªùi gian:</label>
                <select 
                  value={timeFilter} 
                  onChange={(e) => setTimeFilter(e.target.value)}
                  className="filter-select"
                >
                  <option value="all">T·∫•t c·∫£ th·ªùi gian</option>
                  <option value="today">H√¥m nay</option>
                  <option value="week">Tu·∫ßn n√†y</option>
                  <option value="month">Th√°ng n√†y</option>
                  <option value="quarter">Qu√Ω n√†y</option>
                  <option value="year">NƒÉm n√†y</option>
                </select>
              </div>
              <div className="filter-group">
                <label>üè¢ B·ªô ph·∫≠n:</label>
                <select 
                  value={departmentFilter}
                  onChange={(e) => setDepartmentFilter(e.target.value)}
                  className="filter-select"
                >
                  <option value="all">T·∫•t c·∫£ b·ªô ph·∫≠n</option>
                  {Array.from(new Set(jobs.map(job => job.department))).map(dept => (
                    <option key={dept} value={dept}>{dept}</option>
                  ))}
                </select>
              </div>
              <div className="filter-actions">
                <div className="filter-info" style={{ 
                  padding: '8px 12px', 
                  background: 'rgba(255, 255, 255, 0.2)', 
                  borderRadius: '6px', 
                  fontSize: '0.9rem',
                  color: 'white',
                  border: '1px solid rgba(255, 255, 255, 0.3)'
                }}>
                  üìä Hi·ªÉn th·ªã: {getFilteredJobs().length} / {jobs.length} c√¥ng vi·ªác
                </div>
                <button 
                  className="clear-filters-btn"
                  onClick={() => {
                    setTimeFilter('all');
                    setDepartmentFilter('all');
                  }}
                >
                  üîÑ X√≥a b·ªô l·ªçc
                </button>
              </div>
            </div>
          </div>
        </div>

        <div className="stats-grid" key={refreshKey}>
          <div className="stat-card animated">
            <div className="stat-icon">üìã</div>
            <div className="stat-content">
              <h3 className="stat-number">{stats.totalJobs}</h3>
              <p>T·ªïng c√¥ng vi·ªác</p>
              <div className="stat-trend">
                <span className="trend-indicator">üìä</span>
                <span className="trend-text">T·ªïng quan</span>
              </div>
            </div>
          </div>
          
          <div className="stat-card success animated">
            <div className="stat-icon">‚úÖ</div>
            <div className="stat-content">
              <h3 className="stat-number">{stats.completedJobs}</h3>
              <p>Ho√†n th√†nh</p>
              <div className="stat-trend">
                <span className="trend-indicator success">üìà</span>
                <span className="trend-text">Ho√†n th√†nh t·ªët</span>
              </div>
            </div>
          </div>
          
          <div className="stat-card warning animated">
            <div className="stat-icon">‚è≥</div>
            <div className="stat-content">
              <h3 className="stat-number">{stats.pendingJobs}</h3>
              <p>ƒêang x·ª≠ l√Ω</p>
              <div className="stat-trend">
                <span className="trend-indicator warning">‚è∞</span>
                <span className="trend-text">C·∫ßn theo d√µi</span>
              </div>
            </div>
          </div>
          
          <div className="stat-card danger animated">
            <div className="stat-icon">‚ùå</div>
            <div className="stat-content">
              <h3 className="stat-number">{stats.failedJobs}</h3>
              <p>Th·∫•t b·∫°i</p>
              <div className="stat-trend">
                <span className="trend-indicator danger">‚ö†Ô∏è</span>
                <span className="trend-text">C·∫ßn x·ª≠ l√Ω</span>
              </div>
            </div>
          </div>
          
          <div className="stat-card info animated">
            <div className="stat-icon">üë•</div>
            <div className="stat-content">
              <h3 className="stat-number">{stats.totalUsers}</h3>
              <p>T·ªïng ng∆∞·ªùi d√πng</p>
              <div className="stat-trend">
                <span className="trend-indicator info">üë§</span>
                <span className="trend-text">T·ªïng nh√¢n s·ª±</span>
              </div>
            </div>
          </div>
          
          <div className="stat-card primary">
            <div className="stat-icon">üü¢</div>
            <div className="stat-content">
              <h3>{stats.activeUsers}</h3>
              <p>ƒêang ho·∫°t ƒë·ªông</p>
            </div>
          </div>
          
          <div className="stat-card productivity">
            <div className="stat-icon">üìà</div>
            <div className="stat-content">
              <h3>{stats.totalJobs > 0 ? Math.round((stats.completedJobs / stats.totalJobs) * 100) : 0}%</h3>
              <p>T·ªïng nƒÉng su·∫•t</p>
            </div>
          </div>
          
          <div className="stat-card efficiency">
            <div className="stat-icon">‚ö°</div>
            <div className="stat-content">
              <h3>{Object.values(departmentStats).length > 0 ? 
                Math.round(Object.values(departmentStats).reduce((sum, dept) => sum + dept.onTimeRate, 0) / Object.values(departmentStats).length) : 0}%</h3>
              <p>T·ª∑ l·ªá ƒë√∫ng h·∫°n</p>
            </div>
          </div>
          
          <div className="stat-card departments">
            <div className="stat-icon">üè¢</div>
            <div className="stat-content">
              <h3>{Object.keys(departmentStats).length}</h3>
              <p>B·ªô ph·∫≠n ho·∫°t ƒë·ªông</p>
            </div>
          </div>
        </div>

        <div className="charts-grid">
          <div className="chart-card">
            <h3>üìä NƒÉng su·∫•t theo b·ªô ph·∫≠n</h3>
            <div className="chart-content">
              {Object.entries(departmentStats).map(([dept, data]) => (
                <div key={dept} className="chart-bar enhanced">
                  <div className="bar-header">
                  <div className="bar-label">{dept}</div>
                    <div className="bar-status-indicators">
                      <span className="status-dot completed" title="Ho√†n th√†nh">‚óè</span>
                      <span className="status-dot pending" title="ƒêang x·ª≠ l√Ω">‚óè</span>
                      <span className="status-dot failed" title="Th·∫•t b·∫°i">‚óè</span>
                    </div>
                  </div>
                  <div className="bar-container">
                    <div 
                      className="bar-fill" 
                      style={{ 
                        width: `${data.percentage}%`,
                        background: data.percentage >= 80 ? 'linear-gradient(90deg, #28a745 0%, #20c997 100%)' :
                                   data.percentage >= 60 ? 'linear-gradient(90deg, #ffc107 0%, #fd7e14 100%)' :
                                   'linear-gradient(90deg, #dc3545 0%, #e83e8c 100%)'
                      }}
                    ></div>
                  </div>
                  <div className="bar-value">
                    <div className="percentage">{data.percentage}%</div>
                    <div className="count">({data.completed}/{data.total})</div>
                  </div>
                  <div className="bar-details">
                    <div className="detail-row">
                      <span className="detail-item">
                        <span className="detail-icon">‚úÖ</span>
                        {data.completed} ho√†n th√†nh
                      </span>
                      <span className="detail-item">
                        <span className="detail-icon">‚è≥</span>
                        {data.pending} ƒëang x·ª≠ l√Ω
                      </span>
                      <span className="detail-item">
                        <span className="detail-icon">‚ùå</span>
                        {data.failed} th·∫•t b·∫°i
                      </span>
                    </div>
                    <div className="detail-row">
                      <span className="detail-item">
                        <span className="detail-icon">‚ö°</span>
                        {data.onTimeRate}% ƒë√∫ng h·∫°n
                      </span>
                      <span className="detail-item">
                        <span className="detail-icon">üìÖ</span>
                        {data.avgCompletionTime > 0 ? `${Math.round(data.avgCompletionTime)} ng√†y` : 'N/A'}
                      </span>
                      <span className="detail-item">
                        <span className="detail-icon">‚ö†Ô∏è</span>
                        {data.overdue} tr·ªÖ h·∫°n
                      </span>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          <div className="chart-card">
            <h3>üìà Th·ªëng k√™ theo tr·∫°ng th√°i</h3>
            <div className="chart-content">
              {Object.entries(statusStats).map(([status, count]) => (
                <div key={status} className="chart-bar">
                  <div className="bar-label">{status}</div>
                  <div className="bar-container">
                    <div 
                      className="bar-fill" 
                      style={{ width: `${(count / stats.totalJobs) * 100}%` }}
                    ></div>
                  </div>
                  <div className="bar-value">{count}</div>
                </div>
              ))}
            </div>
          </div>
        </div>

        <div className="productivity-summary">
          <h3>üìä T·ªïng quan nƒÉng su·∫•t</h3>
          <div className="productivity-grid">
            {Object.entries(departmentStats).map(([dept, data]) => (
              <div key={dept} className="productivity-card">
                <div className="productivity-header">
                  <h4>{dept}</h4>
                  <div className="productivity-percentage">
                    {data.percentage}%
                  </div>
                </div>
                <div className="productivity-bar">
                  <div 
                    className="productivity-fill"
                    style={{ 
                      width: `${data.percentage}%`,
                      background: data.percentage >= 80 ? 'linear-gradient(90deg, #28a745 0%, #20c997 100%)' :
                                 data.percentage >= 60 ? 'linear-gradient(90deg, #ffc107 0%, #fd7e14 100%)' :
                                 'linear-gradient(90deg, #dc3545 0%, #e83e8c 100%)'
                    }}
                  ></div>
                </div>
                <div className="productivity-details">
                  <span>Ho√†n th√†nh: {data.completed}/{data.total}</span>
                  <span className={`productivity-status ${
                    data.percentage >= 80 ? 'excellent' :
                    data.percentage >= 60 ? 'good' : 'needs-improvement'
                  }`}>
                    {data.percentage >= 80 ? 'Xu·∫•t s·∫Øc' :
                     data.percentage >= 60 ? 'T·ªët' : 'C·∫ßn c·∫£i thi·ªán'}
                  </span>
                </div>
              </div>
            ))}
          </div>
        </div>

        <div className="performance-insights">
          <h3>üîç Ph√¢n t√≠ch hi·ªáu su·∫•t chi ti·∫øt</h3>
          <div className="insights-grid">
            <div className="insight-card">
              <h4>üìä Top B·ªô ph·∫≠n</h4>
              <div className="insight-content">
                {Object.entries(departmentStats)
                  .sort(([,a], [,b]) => b.percentage - a.percentage)
                  .slice(0, 3)
                  .map(([dept, data], index) => (
                    <div key={dept} className="insight-item">
                      <div className="insight-rank">#{index + 1}</div>
                      <div className="insight-info">
                        <div className="insight-name">{dept}</div>
                        <div className="insight-stats">
                          {data.percentage}% ‚Ä¢ {data.completed}/{data.total} c√¥ng vi·ªác
                        </div>
                      </div>
                    </div>
                  ))}
              </div>
            </div>
            
            <div className="insight-card">
              <h4>‚ö° Hi·ªáu su·∫•t th·ªùi gian</h4>
              <div className="insight-content">
                {Object.entries(departmentStats)
                  .filter(([,data]) => data.avgCompletionTime > 0)
                  .sort(([,a], [,b]) => a.avgCompletionTime - b.avgCompletionTime)
                  .slice(0, 3)
                  .map(([dept, data]) => (
                    <div key={dept} className="insight-item">
                      <div className="insight-info">
                        <div className="insight-name">{dept}</div>
                        <div className="insight-stats">
                          {Math.round(data.avgCompletionTime)} ng√†y trung b√¨nh
                        </div>
                      </div>
                    </div>
                  ))}
              </div>
            </div>
            
            <div className="insight-card">
              <h4>üéØ T·ª∑ l·ªá ƒë√∫ng h·∫°n</h4>
              <div className="insight-content">
                {Object.entries(departmentStats)
                  .sort(([,a], [,b]) => b.onTimeRate - a.onTimeRate)
                  .slice(0, 3)
                  .map(([dept, data]) => (
                    <div key={dept} className="insight-item">
                      <div className="insight-info">
                        <div className="insight-name">{dept}</div>
                        <div className="insight-stats">
                          {data.onTimeRate}% ƒë√∫ng h·∫°n
                        </div>
                      </div>
                    </div>
                  ))}
              </div>
            </div>
          </div>
        </div>

        <div className="recent-activity">
          <h3>üïí Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h3>
          <div className="activity-list">
            {filteredJobs.slice(-5).reverse().map(job => (
              <div key={job.id} className="activity-item">
                <div className="activity-icon">
                  {job.status === 'th√†nh c√¥ng' ? '‚úÖ' : 
                   job.status === 'th·∫•t b·∫°i' ? '‚ùå' : 
                   job.status === 'ƒëang x·ª≠ l√Ω' ? '‚è≥' : 
                   job.status === 'nh·∫≠n vi·ªác' ? 'üìã' : '‚è∏Ô∏è'}
                </div>
                <div className="activity-content">
                  <div className="activity-title">{job.description}</div>
                  <div className="activity-meta">
                    {job.department} ‚Ä¢ {job.assigner || 'Ch∆∞a giao'} ‚Üí {job.assignee || 'Ch∆∞a giao'} ‚Ä¢ {new Date(job.deliveryDate).toLocaleDateString('vi-VN')} ‚Ä¢ {job.status}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  };

  // KPI Evaluation Component
  const KPIEvaluation = ({ users, jobs, currentUser }) => {
    const [selectedUser, setSelectedUser] = useState(null);
    const [evaluationDate, setEvaluationDate] = useState(new Date().toISOString().split('T')[0]);
    const [evaluationData, setEvaluationData] = useState({
      performance: 0,
      discipline: 0,
      attitude: 0
    });
    const [isEvaluating, setIsEvaluating] = useState(false);
    const [evaluationHistory, setEvaluationHistory] = useState([]);
    const [viewMode, setViewMode] = useState('evaluate'); // 'evaluate', 'history', 'all-evaluations'
    const [summaryPeriod, setSummaryPeriod] = useState('week'); // 'week', 'month', 'quarter', 'year'
    const [selectedDepartment, setSelectedDepartment] = useState('all'); // 'all' ho·∫∑c t√™n b·ªô ph·∫≠n
    const [allEvaluations, setAllEvaluations] = useState([]); // L∆∞u t·∫•t c·∫£ ƒë√°nh gi√° KPI
    const [expandedUser, setExpandedUser] = useState(null); // Track which user's details are expanded
    const [historyTimeFilter, setHistoryTimeFilter] = useState('all'); // Filter for history tab
    const [historyDepartmentFilter, setHistoryDepartmentFilter] = useState('all'); // Department filter for history tab
    const [historyDateFilter, setHistoryDateFilter] = useState(''); // Specific date filter for history tab
    const [weeklyTimeFilter, setWeeklyTimeFilter] = useState('all'); // Filter for weekly summary
    const [weeklyDepartmentFilter, setWeeklyDepartmentFilter] = useState('all'); // Department filter for weekly summary

    // Load KPI evaluations from server
    const loadKpiEvaluations = useCallback(async () => {
      try {
        const currentApiBase = window.API_BASE || API_BASE;
        const response = await fetch(`${currentApiBase}/api/kpi-evaluations`);
        const result = await response.json();
        if (result.success) {
          setAllEvaluations(result.data || []);
          setEvaluationHistory(result.data || []);
        }
      } catch (error) {
        console.error('‚ùå L·ªói load KPI evaluations:', error);
      }
    }, []);

    // Save KPI evaluations to server
    const saveKpiEvaluations = useCallback(async (evaluations) => {
      try {
        const currentApiBase = window.API_BASE || API_BASE;
        const response = await fetch(`${currentApiBase}/api/kpi-evaluations`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ evaluations }),
        });
        const result = await response.json();
        if (!result.success) {
          console.error('‚ùå L·ªói save KPI evaluations:', result.error);
        }
      } catch (error) {
        console.error('‚ùå L·ªói save KPI evaluations:', error);
      }
    }, []);

    // Load evaluations when component mounts
    useEffect(() => {
      loadKpiEvaluations();
    }, [loadKpiEvaluations]);


    // L·∫•y danh s√°ch b·ªô ph·∫≠n t·ª´ users c√≥ th·ªÉ ƒë√°nh gi√°
    const getAvailableDepartments = () => {
      let availableUsers = [];
      
      if (currentUser?.role === 'admin' || currentUser?.position === 'Qu·∫£n l√Ω') {
        // Qu·∫£n l√Ω ƒë√°nh gi√° T·ªï tr∆∞·ªüng
        availableUsers = users.filter(user => 
          user.role !== 'admin' && 
          user.position === 'T·ªï tr∆∞·ªüng'
        );
      } else if (currentUser?.position === 'T·ªï tr∆∞·ªüng') {
        // T·ªï tr∆∞·ªüng ƒë√°nh gi√° T·ªï ph√≥ v√† Nh√¢n vi√™n trong c√πng b·ªô ph·∫≠n
        availableUsers = users.filter(user => 
          user.role !== 'admin' && 
          (user.position === 'T·ªï ph√≥' || user.position === 'Nh√¢n vi√™n') &&
          user.department === currentUser.department
        );
      } else if (currentUser?.position === 'T·ªï ph√≥') {
        // T·ªï ph√≥ ƒë√°nh gi√° Nh√¢n vi√™n trong c√πng b·ªô ph·∫≠n
        availableUsers = users.filter(user => 
          user.role !== 'admin' && 
          user.position === 'Nh√¢n vi√™n' &&
          user.department === currentUser.department
        );
      }
      
      return Array.from(new Set(availableUsers.map(user => user.department))).filter(dept => dept);
    };

    // L·∫•y danh s√°ch b·ªô ph·∫≠n cho b·ªô l·ªçc l·ªãch s·ª≠
    const getHistoryDepartments = () => {
      if (currentUser?.role === 'admin' || currentUser?.position === 'Qu·∫£n l√Ω') {
        // Qu·∫£n l√Ω xem t·∫•t c·∫£ b·ªô ph·∫≠n
        return Array.from(new Set(users.map(user => user.department))).filter(dept => dept);
      } else {
        // C√°c c·∫•p kh√°c ch·ªâ xem b·ªô ph·∫≠n m√¨nh
        return [currentUser?.department].filter(dept => dept);
      }
    };
    
    const departments = getAvailableDepartments();
    
    // L·ªçc users theo b·ªô ph·∫≠n v√† quy·ªÅn ƒë√°nh gi√°
    const getFilteredUsers = () => {
      let filteredUsers = [];
      
      // Quy·ªÅn ƒë√°nh gi√° theo c·∫•p b·∫≠c
      if (currentUser?.role === 'admin' || currentUser?.position === 'Qu·∫£n l√Ω') {
        // Qu·∫£n l√Ω ƒë√°nh gi√° T·ªï tr∆∞·ªüng
        filteredUsers = users.filter(user => 
          user.role !== 'admin' && 
          user.position === 'T·ªï tr∆∞·ªüng'
        );
      } else if (currentUser?.position === 'T·ªï tr∆∞·ªüng') {
        // T·ªï tr∆∞·ªüng ƒë√°nh gi√° T·ªï ph√≥ v√† Nh√¢n vi√™n trong c√πng b·ªô ph·∫≠n
        filteredUsers = users.filter(user => 
          user.role !== 'admin' && 
          (user.position === 'T·ªï ph√≥' || user.position === 'Nh√¢n vi√™n') &&
          user.department === currentUser.department
        );
      } else if (currentUser?.position === 'T·ªï ph√≥') {
        // T·ªï ph√≥ ƒë√°nh gi√° Nh√¢n vi√™n trong c√πng b·ªô ph·∫≠n
        filteredUsers = users.filter(user => 
          user.role !== 'admin' && 
          user.position === 'Nh√¢n vi√™n' &&
          user.department === currentUser.department
        );
      }
      
      // L·ªçc theo b·ªô ph·∫≠n n·∫øu ƒë∆∞·ª£c ch·ªçn
      if (selectedDepartment !== 'all') {
        filteredUsers = filteredUsers.filter(user => user.department === selectedDepartment);
      }
      
      return filteredUsers;
    };

    const filteredUsers = getFilteredUsers();

    const criteria = [
      {
        name: 'performance',
        title: 'Hi·ªáu qu·∫£ c√¥ng vi·ªác',
        weight: 50,
        description: 'NƒÉng su·∫•t, ch·∫•t l∆∞·ª£ng, ti·∫øn ƒë·ªô, linh ho·∫°t',
        maxScore: 100
      },
      {
        name: 'discipline',
        title: 'K·ª∑ lu·∫≠t & Tu√¢n th·ªß',
        weight: 30,
        description: 'Gi·ªù gi·∫•c, n·ªôi quy, an to√†n, gi·ªØ g√¨n',
        maxScore: 100
      },
      {
        name: 'attitude',
        title: 'Th√°i ƒë·ªô & H·ª£p t√°c',
        weight: 20,
        description: 'Tr√°ch nhi·ªám, h·ª£p t√°c, h·ªçc h·ªèi, ch·ªß ƒë·ªông',
        maxScore: 100
      }
    ];

    const handleScoreChange = (criteria, value) => {
      setEvaluationData(prev => ({
        ...prev,
        [criteria]: parseInt(value) || 0
      }));
    };

    const calculateTotalScore = () => {
      let totalScore = 0;
      let totalWeight = 0;

      criteria.forEach(criterion => {
        const score = evaluationData[criterion.name];
        const weightedScore = (score * criterion.weight) / 100;
        totalScore += weightedScore;
        totalWeight += criterion.weight;
      });

      return Math.round(totalScore);
    };

    const getScoreLevel = (score) => {
      if (score >= 90) return { level: 'Xu·∫•t s·∫Øc', color: '#28a745' };
      if (score >= 80) return { level: 'T·ªët', color: '#17a2b8' };
      if (score >= 70) return { level: 'Kh√°', color: '#6f42c1' };
      if (score >= 50) return { level: 'Trung b√¨nh', color: '#ffc107' };
      return { level: 'Y·∫øu', color: '#dc3545' };
    };

    // Calculate summary statistics
    const calculateSummary = () => {
      try {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      
        console.log('üîç Debug calculateSummary:', {
          summaryPeriod,
          today: today.toLocaleDateString('vi-VN'),
          allEvaluationsLength: allEvaluations.length
        });
        
        let startDate, endDate;
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth(); // 0-indexed
      
      switch (summaryPeriod) {
        case 'week':
          // Current week: from Monday to Sunday
          startDate = new Date(today);
          startDate.setDate(today.getDate() - today.getDay() + 1); // Monday
          endDate = new Date(today);
          endDate.setDate(today.getDate() - today.getDay() + 7); // Sunday
          break;
        case 'month':
          startDate = new Date(currentYear, currentMonth, 1);
          endDate = new Date(currentYear, currentMonth + 1, 0);
          break;
        case 'quarter':
          const quarter = Math.floor(currentMonth / 3);
          startDate = new Date(currentYear, quarter * 3, 1);
          endDate = new Date(currentYear, quarter * 3 + 3, 0);
          break;
        case 'year':
          startDate = new Date(currentYear, 0, 1);
          endDate = new Date(currentYear, 11, 31);
          break;
        // Specific weeks in current month - weeks end on Sunday
        case 'week1':
          startDate = new Date(currentYear, currentMonth, 1);
          const firstDay = new Date(currentYear, currentMonth, 1);
          const firstDayOfWeek = firstDay.getDay();
          if (firstDayOfWeek === 0) {
            endDate = new Date(currentYear, currentMonth, 1);
          } else {
            const daysToSunday = 7 - firstDayOfWeek;
            endDate = new Date(currentYear, currentMonth, 1 + daysToSunday);
          }
          break;
        case 'week2':
          // Start from day after week 1's Sunday
          const week1End = new Date(currentYear, currentMonth, 1);
          const week1EndDayOfWeek = week1End.getDay();
          if (week1EndDayOfWeek === 0) {
            startDate = new Date(currentYear, currentMonth, 2);
          } else {
            const daysToFirstSunday = 7 - week1EndDayOfWeek;
            startDate = new Date(currentYear, currentMonth, 1 + daysToFirstSunday + 1);
          }
          const week2StartDayOfWeek = startDate.getDay();
          if (week2StartDayOfWeek === 0) {
            endDate = new Date(startDate);
          } else {
            const daysToSunday = 7 - week2StartDayOfWeek;
            endDate = new Date(currentYear, currentMonth, startDate.getDate() + daysToSunday);
          }
          break;
        case 'week3':
          // Start from day after week 2's Sunday
          const week2End = new Date(currentYear, currentMonth, 1);
          const week2EndDayOfWeek = week2End.getDay();
          if (week2EndDayOfWeek === 0) {
            startDate = new Date(currentYear, currentMonth, 2 + 7);
          } else {
            const daysToFirstSunday = 7 - week2EndDayOfWeek;
            startDate = new Date(currentYear, currentMonth, 1 + daysToFirstSunday + 1 + 7);
          }
          const week3StartDayOfWeek = startDate.getDay();
          if (week3StartDayOfWeek === 0) {
            endDate = new Date(startDate);
          } else {
            const daysToSunday = 7 - week3StartDayOfWeek;
            endDate = new Date(currentYear, currentMonth, startDate.getDate() + daysToSunday);
          }
          break;
        case 'week4':
          // Start from day after week 3's Sunday
          const week3End = new Date(currentYear, currentMonth, 1);
          const week3EndDayOfWeek = week3End.getDay();
          if (week3EndDayOfWeek === 0) {
            startDate = new Date(currentYear, currentMonth, 2 + 14);
          } else {
            const daysToFirstSunday = 7 - week3EndDayOfWeek;
            startDate = new Date(currentYear, currentMonth, 1 + daysToFirstSunday + 1 + 14);
          }
          const week4StartDayOfWeek = startDate.getDay();
          if (week4StartDayOfWeek === 0) {
            endDate = new Date(startDate);
          } else {
            const daysToSunday = 7 - week4StartDayOfWeek;
            endDate = new Date(currentYear, currentMonth, startDate.getDate() + daysToSunday);
          }
          break;
        case 'week5':
          // Start from day after week 4's Sunday
          const week4End = new Date(currentYear, currentMonth, 1);
          const week4EndDayOfWeek = week4End.getDay();
          if (week4EndDayOfWeek === 0) {
            startDate = new Date(currentYear, currentMonth, 2 + 21);
          } else {
            const daysToFirstSunday = 7 - week4EndDayOfWeek;
            startDate = new Date(currentYear, currentMonth, 1 + daysToFirstSunday + 1 + 21);
          }
          const week5StartDayOfWeek = startDate.getDay();
          if (week5StartDayOfWeek === 0) {
            endDate = new Date(startDate);
          } else {
            const daysToSunday = 7 - week5StartDayOfWeek;
            endDate = new Date(currentYear, currentMonth, startDate.getDate() + daysToSunday);
          }
          // Ensure week 5 doesn't exceed month boundaries
          const monthEnd = new Date(currentYear, currentMonth + 1, 0);
          if (endDate.getDate() > monthEnd.getDate()) {
            endDate = new Date(monthEnd);
          }
          break;
        // Specific months in current year
        case 'month1':
          startDate = new Date(currentYear, 0, 1);
          endDate = new Date(currentYear, 0, 31);
          break;
        case 'month2':
          startDate = new Date(currentYear, 1, 1);
          endDate = new Date(currentYear, 1, 28); // February
          break;
        case 'month3':
          startDate = new Date(currentYear, 2, 1);
          endDate = new Date(currentYear, 2, 31);
          break;
        case 'month4':
          startDate = new Date(currentYear, 3, 1);
          endDate = new Date(currentYear, 3, 30);
          break;
        case 'month5':
          startDate = new Date(currentYear, 4, 1);
          endDate = new Date(currentYear, 4, 31);
          break;
        case 'month6':
          startDate = new Date(currentYear, 5, 1);
          endDate = new Date(currentYear, 5, 30);
          break;
        case 'month7':
          startDate = new Date(currentYear, 6, 1);
          endDate = new Date(currentYear, 6, 31);
          break;
        case 'month8':
          startDate = new Date(currentYear, 7, 1);
          endDate = new Date(currentYear, 7, 31);
          break;
        case 'month9':
          startDate = new Date(currentYear, 8, 1);
          endDate = new Date(currentYear, 8, 30);
          break;
        case 'month10':
          startDate = new Date(currentYear, 9, 1);
          endDate = new Date(currentYear, 9, 31);
          break;
        case 'month11':
          startDate = new Date(currentYear, 10, 1);
          endDate = new Date(currentYear, 10, 30);
          break;
        case 'month12':
          startDate = new Date(currentYear, 11, 1);
          endDate = new Date(currentYear, 11, 31);
          break;
        // Specific week in specific month
        default:
          if (summaryPeriod.includes('_week')) {
            const [monthPart, weekPart] = summaryPeriod.split('_week');
            const monthNum = parseInt(monthPart.replace('month', '')) - 1; // Convert to 0-indexed
            const weekNum = parseInt(weekPart);
            
            if (monthNum >= 0 && monthNum <= 11 && weekNum >= 1 && weekNum <= 5) {
              const monthStart = new Date(currentYear, monthNum, 1);
              const monthEnd = new Date(currentYear, monthNum + 1, 0);
              
              // Calculate week boundaries - weeks end on Sunday
              if (weekNum === 1) {
                // Week 1: From 1st day of month to next Sunday
                startDate = new Date(currentYear, monthNum, 1);
                
                // Find the first Sunday of the month
                const firstDay = new Date(currentYear, monthNum, 1);
                const firstDayOfWeek = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
                
                if (firstDayOfWeek === 0) {
                  // If 1st is Sunday, week ends on same day
                  endDate = new Date(currentYear, monthNum, 1);
                } else {
                  // Find next Sunday
                  const daysToSunday = 7 - firstDayOfWeek;
                  endDate = new Date(currentYear, monthNum, 1 + daysToSunday);
                }
              } else {
                // Week 2+: Start from day after previous week's Sunday
                const prevWeekEnd = new Date(currentYear, monthNum, 1);
                const firstDayOfWeek = prevWeekEnd.getDay();
                
                if (firstDayOfWeek === 0) {
                  // If 1st is Sunday, week 2 starts on 2nd
                  const weekStartDay = 1 + (weekNum - 1) * 7;
                  startDate = new Date(currentYear, monthNum, weekStartDay);
                } else {
                  // Calculate start of current week
                  const daysToFirstSunday = 7 - firstDayOfWeek;
                  const weekStartDay = 1 + daysToFirstSunday + (weekNum - 2) * 7;
                  startDate = new Date(currentYear, monthNum, weekStartDay);
                }
                
                // Week ends on Sunday
                const weekStartDayOfWeek = startDate.getDay();
                if (weekStartDayOfWeek === 0) {
                  // If week starts on Sunday, it ends same day
                  endDate = new Date(startDate);
                } else {
                  // Find next Sunday
                  const daysToSunday = 7 - weekStartDayOfWeek;
                  endDate = new Date(currentYear, monthNum, startDate.getDate() + daysToSunday);
                }
              }
              
              // Ensure dates don't exceed month boundaries
              if (startDate.getMonth() !== monthNum) {
                startDate = new Date(currentYear, monthNum, 1);
              }
              if (endDate.getMonth() !== monthNum || endDate.getDate() > monthEnd.getDate()) {
                endDate = new Date(monthEnd);
              }
              
              // Debug log for week calculation
              console.log(`üìÖ ${summaryPeriod}: ${startDate.toLocaleDateString('vi-VN')} - ${endDate.toLocaleDateString('vi-VN')}`);
              
            } else {
          startDate = new Date(0);
              endDate = new Date();
            }
          } else {
            startDate = new Date(0);
            endDate = new Date();
          }
          break;
      }

      const filteredEvaluations = allEvaluations.filter(evaluation => {
        const evalDate = new Date(evaluation.date);
        return evalDate >= startDate && evalDate <= endDate;
      });

      if (filteredEvaluations.length === 0) {
        return {
          totalEvaluations: 0,
          averageScore: 0,
          topPerformers: [],
          departmentStats: {},
          scoreDistribution: { excellent: 0, good: 0, average: 0, poor: 0 }
        };
      }

      // Calculate average score
      const totalScore = filteredEvaluations.reduce((sum, evaluation) => sum + evaluation.totalScore, 0);
      const averageScore = Math.round(totalScore / filteredEvaluations.length);

      // Top performers
      const topPerformers = filteredEvaluations
        .sort((a, b) => b.totalScore - a.totalScore)
        .slice(0, 5);

      // Department statistics
      const departmentStats = filteredEvaluations.reduce((acc, evaluation) => {
        if (!acc[evaluation.department]) {
          acc[evaluation.department] = { count: 0, totalScore: 0, average: 0 };
        }
        acc[evaluation.department].count += 1;
        acc[evaluation.department].totalScore += evaluation.totalScore;
        acc[evaluation.department].average = Math.round(acc[evaluation.department].totalScore / acc[evaluation.department].count);
        return acc;
      }, {});

      // Score distribution (A/B/C/D)
      const scoreDistribution = filteredEvaluations.reduce((acc, evaluation) => {
        if (evaluation.totalScore >= 90) acc.excellent += 1; // Xu·∫•t s·∫Øc
        else if (evaluation.totalScore >= 80) acc.good += 1; // T·ªët
        else if (evaluation.totalScore >= 70) acc.average += 1; // Trung b√¨nh
        else acc.poor += 1; // C·∫ßn c·∫£i thi·ªán
        return acc;
      }, { excellent: 0, good: 0, average: 0, poor: 0 });

      // Calculate monthly trends
      const monthlyTrend = calculateMonthlyTrend();
      const dailyKPI = calculateDailyKPI();

      return {
        totalEvaluations: filteredEvaluations.length,
        averageScore,
        topPerformers,
        departmentStats,
        scoreDistribution,
        monthlyTrend,
        dailyKPI
      };
      } catch (error) {
        console.error('‚ùå Error in calculateSummary:', error);
        return {
          totalEvaluations: 0,
          averageScore: 0,
          topPerformers: [],
          departmentStats: {},
          scoreDistribution: { excellent: 0, good: 0, average: 0, poor: 0 },
          monthlyTrend: [],
          dailyKPI: []
        };
      }
    };


    // Calculate monthly trend
    const calculateMonthlyTrend = () => {
      const months = [];
      const now = new Date();
      
      for (let i = 5; i >= 0; i--) {
        const monthStart = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const monthEnd = new Date(now.getFullYear(), now.getMonth() - i + 1, 0);
        
        const monthEvaluations = allEvaluations.filter(evaluation => {
          const evalDate = new Date(evaluation.date);
          return evalDate >= monthStart && evalDate <= monthEnd;
        });
        
        // Calculate average of 4 weeks in the month
        const weeklyAverages = calculateWeeklyAveragesInMonth(monthStart, monthEnd);
        const monthlyAverage = weeklyAverages.length > 0 
          ? Math.round(weeklyAverages.reduce((sum, avg) => sum + avg, 0) / weeklyAverages.length)
          : 0;
        
        months.push({
          month: `${monthStart.getMonth() + 1}/${monthStart.getFullYear()}`,
          evaluations: monthEvaluations.length,
          averageScore: monthlyAverage,
          weeklyAverages: weeklyAverages,
          date: monthStart
        });
      }
      
      return months;
    };

    // Calculate daily KPI for all weeks in current month
    const calculateDailyKPI = () => {
      try {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        
        // Get first and last day of current month
        const monthStart = new Date(currentYear, currentMonth, 1);
        const monthEnd = new Date(currentYear, currentMonth + 1, 0);
        
        const days = [];
        const dayNames = ['Ch·ªß nh·∫≠t', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'];
        
        // Generate all days in the current month
        const current = new Date(monthStart);
        while (current <= monthEnd) {
          const dayStart = new Date(current);
          dayStart.setHours(0, 0, 0, 0);
          const dayEnd = new Date(current);
          dayEnd.setHours(23, 59, 59, 999);
          
          const dayEvaluations = allEvaluations.filter(evaluation => {
            const evalDate = new Date(evaluation.date);
            return evalDate >= dayStart && evalDate <= dayEnd;
          });
          
          const avgScore = dayEvaluations.length > 0 
            ? Math.round(dayEvaluations.reduce((sum, evaluation) => sum + evaluation.totalScore, 0) / dayEvaluations.length)
            : 0;
          
          const dayName = dayNames[current.getDay()];
          
          // Calculate week number - weeks always end on Sunday
          const dayOfMonth = current.getDate();
          const firstDayOfMonth = monthStart.getDay(); // 0=Sunday, 1=Monday, etc.
          
          // Find the Sunday that ends the week containing this day
          const dayOfWeek = current.getDay(); // 0=Sunday, 1=Monday, etc.
          const daysToSunday = dayOfWeek === 0 ? 0 : 7 - dayOfWeek;
          const weekEndingSunday = new Date(current);
          weekEndingSunday.setDate(current.getDate() + daysToSunday);
          
          // Calculate week number based on which Sunday this week ends on
          let weekNumber;
          if (firstDayOfMonth === 0) { // Month starts on Sunday
            weekNumber = Math.ceil(dayOfMonth / 7);
          } else {
            // Find the first Sunday of the month
            const firstSunday = new Date(monthStart);
            if (firstDayOfMonth === 0) {
              // Already Sunday
            } else {
              firstSunday.setDate(1 + (7 - firstDayOfMonth));
            }
            
            // Calculate week number based on which Sunday this week ends on
            const daysDiff = Math.floor((weekEndingSunday - firstSunday) / (1000 * 60 * 60 * 24));
            weekNumber = Math.floor(daysDiff / 7) + 1;
            
            // If this day is before the first Sunday, it's week 1
            if (current < firstSunday) {
              weekNumber = 1;
            }
          }
          
          days.push({
            day: dayName,
            date: current.toLocaleDateString('vi-VN'),
            evaluationsCount: dayEvaluations.length,
            averageScore: avgScore,
            evaluations: dayEvaluations,
            weekNumber: weekNumber
          });
          
          current.setDate(current.getDate() + 1);
        }
        
        return days;
      } catch (error) {
        console.error('‚ùå Error in calculateDailyKPI:', error);
        return [];
      }
    };

    // Calculate weekly averages in a month
    const calculateWeeklyAveragesInMonth = (monthStart, monthEnd) => {
      const weeklyAverages = [];
      const current = new Date(monthStart);
      
      while (current <= monthEnd) {
        const weekStart = new Date(current);
        const weekEnd = new Date(current);
        weekEnd.setDate(current.getDate() + 6);
        
        // Adjust if week goes beyond month
        if (weekEnd > monthEnd) {
          weekEnd.setTime(monthEnd.getTime());
        }
        
        const weekEvaluations = allEvaluations.filter(evaluation => {
          const evalDate = new Date(evaluation.date);
          return evalDate >= weekStart && evalDate <= weekEnd;
        });
        
        const weekAvg = weekEvaluations.length > 0 
          ? Math.round(weekEvaluations.reduce((sum, evaluation) => sum + evaluation.totalScore, 0) / weekEvaluations.length)
          : 0;
        
        weeklyAverages.push(weekAvg);
        
        // Move to next week
        current.setDate(current.getDate() + 7);
      }
      
      return weeklyAverages;
    };

    // Export Daily KPI to Excel
    const exportDailyKPIExcel = (dailyData) => {
      try {
        // Create CSV content with BOM for proper UTF-8 encoding
        let csvContent = "\uFEFF"; // BOM for UTF-8
        csvContent += "Ng√†y,Th·ª©,ƒê√°nh gi√°,ƒêi·ªÉm trung b√¨nh\n";
        
        dailyData.forEach(day => {
          csvContent += `${day.date},${day.day},${day.evaluationsCount},${day.averageScore}\n`;
        });
        
        // Create and download file with proper encoding
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `Bao_cao_KPI_ngay_${new Date().toLocaleDateString('vi-VN').replace(/\//g, '-')}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert('‚úÖ ƒê√£ xu·∫•t b√°o c√°o KPI theo ng√†y th√†nh c√¥ng!');
      } catch (error) {
        console.error('‚ùå L·ªói xu·∫•t file:', error);
        alert('‚ùå L·ªói khi xu·∫•t file. Vui l√≤ng th·ª≠ l·∫°i.');
      }
    };

    // Export Monthly KPI to Excel
    const exportMonthlyKPIExcel = (monthlyData) => {
      try {
        // Create CSV content with BOM for proper UTF-8 encoding
        let csvContent = "\uFEFF"; // BOM for UTF-8
        csvContent += "Th√°ng,ƒê√°nh gi√°,ƒêi·ªÉm trung b√¨nh,ƒêi·ªÉm TB tu·∫ßn 1,ƒêi·ªÉm TB tu·∫ßn 2,ƒêi·ªÉm TB tu·∫ßn 3,ƒêi·ªÉm TB tu·∫ßn 4\n";
        
        monthlyData.forEach(month => {
          const weeklyAvgs = month.weeklyAverages || [];
          csvContent += `${month.month},${month.evaluations},${month.averageScore},${weeklyAvgs[0] || 0},${weeklyAvgs[1] || 0},${weeklyAvgs[2] || 0},${weeklyAvgs[3] || 0}\n`;
        });
        
        // Create and download file with proper encoding
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `Bao_cao_KPI_thang_${new Date().toLocaleDateString('vi-VN').replace(/\//g, '-')}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert('‚úÖ ƒê√£ xu·∫•t b√°o c√°o KPI theo th√°ng th√†nh c√¥ng!');
      } catch (error) {
        console.error('‚ùå L·ªói xu·∫•t file:', error);
        alert('‚ùå L·ªói khi xu·∫•t file. Vui l√≤ng th·ª≠ l·∫°i.');
      }
    };

    // Export Department KPI to Excel
    const exportDepartmentKPIExcel = (departmentStats) => {
      try {
        // Create CSV content with BOM for proper UTF-8 encoding
        let csvContent = "\uFEFF"; // BOM for UTF-8
        csvContent += "B·ªô ph·∫≠n,S·ªë ƒë√°nh gi√°,ƒêi·ªÉm trung b√¨nh\n";
        
        Object.entries(departmentStats).forEach(([dept, stats]) => {
          csvContent += `${dept},${stats.count},${stats.average}\n`;
        });
        
        // Create and download file with proper encoding
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `Bao_cao_KPI_bo_phan_${new Date().toLocaleDateString('vi-VN').replace(/\//g, '-')}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert('‚úÖ ƒê√£ xu·∫•t b√°o c√°o KPI theo b·ªô ph·∫≠n th√†nh c√¥ng!');
      } catch (error) {
        console.error('‚ùå L·ªói xu·∫•t file:', error);
        alert('‚ùå L·ªói khi xu·∫•t file. Vui l√≤ng th·ª≠ l·∫°i.');
      }
    };

    // Export All Evaluations to Excel (with current filters)
    const exportAllEvaluationsExcel = () => {
      try {
        // Get filtered evaluations - use the same logic as display
        const filteredEvaluations = allEvaluations.filter(evaluation => {
          // Filter by department
          if (selectedDepartment !== 'all' && evaluation.department !== selectedDepartment) {
            return false;
          }
          
          // Filter by time period
          const evalDate = new Date(evaluation.date);
          const today = new Date();
          let startDate;
          
          switch (summaryPeriod) {
            case 'week':
              // Current week: from Monday to Sunday
              startDate = new Date(today);
              startDate.setDate(today.getDate() - today.getDay() + 1); // Monday
              const endDate = new Date(today);
              endDate.setDate(today.getDate() - today.getDay() + 7); // Sunday
              return evalDate >= startDate && evalDate <= endDate;
            case 'month':
              startDate = new Date(today.getFullYear(), today.getMonth(), 1);
              break;
            case 'quarter':
              const quarter = Math.floor(today.getMonth() / 3);
              startDate = new Date(today.getFullYear(), quarter * 3, 1);
              break;
            case 'year':
              startDate = new Date(today.getFullYear(), 0, 1);
              break;
            default:
              // Show all evaluations when no specific period is selected
              return true;
          }
          
          return evalDate >= startDate && evalDate <= today;
        });

        exportEvaluationsToCSV(filteredEvaluations, 'Danh_sach_danh_gia_KPI');
      } catch (error) {
        console.error('‚ùå L·ªói xu·∫•t file:', error);
        alert('‚ùå L·ªói khi xu·∫•t file. Vui l√≤ng th·ª≠ l·∫°i.');
      }
    };

    // Export All Evaluations to Excel (without filters)
    const exportAllEvaluationsExcelUnfiltered = () => {
      try {
        exportEvaluationsToCSV(allEvaluations, 'Tat_ca_danh_gia_KPI');
      } catch (error) {
        console.error('‚ùå L·ªói xu·∫•t file:', error);
        alert('‚ùå L·ªói khi xu·∫•t file. Vui l√≤ng th·ª≠ l·∫°i.');
      }
    };

    // Helper function to export evaluations to CSV
    const exportEvaluationsToCSV = (evaluations, filenamePrefix) => {
      try {
        // Debug log
        console.log('Export Debug:');
        console.log('- Evaluations to export:', evaluations.length);
        console.log('- Data:', evaluations);

        // Create CSV content with BOM for proper UTF-8 encoding
        let csvContent = "\uFEFF"; // BOM for UTF-8
        csvContent += "STT,Nh√¢n vi√™n,B·ªô ph·∫≠n,Ng√†y ƒë√°nh gi√°,Hi·ªáu qu·∫£,K·ª∑ lu·∫≠t,Th√°i ƒë·ªô,T·ªïng ƒëi·ªÉm,X·∫øp lo·∫°i\n";
        
        evaluations.forEach((evaluation, index) => {
          csvContent += `${index + 1},${evaluation.userName},${evaluation.department},${new Date(evaluation.date).toLocaleDateString('vi-VN')},${evaluation.scores.performance},${evaluation.scores.discipline},${evaluation.scores.attitude},${evaluation.totalScore},${evaluation.level}\n`;
        });
        
        // Create and download file with proper encoding
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `${filenamePrefix}_${new Date().toLocaleDateString('vi-VN').replace(/\//g, '-')}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert(`‚úÖ ƒê√£ xu·∫•t ${evaluations.length} ƒë√°nh gi√° KPI th√†nh c√¥ng!`);
      } catch (error) {
        console.error('‚ùå L·ªói xu·∫•t file:', error);
        alert('‚ùå L·ªói khi xu·∫•t file. Vui l√≤ng th·ª≠ l·∫°i.');
      }
    };

    // Export weekly summaries to CSV
    const exportWeeklySummariesToCSV = (weeklySummaries, filenamePrefix) => {
      try {
        // Create CSV content with BOM for proper UTF-8 encoding
        let csvContent = "\uFEFF"; // BOM for UTF-8
        csvContent += "STT,Nh√¢n vi√™n,B·ªô ph·∫≠n,Tu·∫ßn t·ª´,Tu·∫ßn ƒë·∫øn,S·ªë ƒë√°nh gi√° ng√†y,ƒêi·ªÉm TB hi·ªáu qu·∫£,ƒêi·ªÉm TB k·ª∑ lu·∫≠t,ƒêi·ªÉm TB th√°i ƒë·ªô,ƒêi·ªÉm TB t·ªïng,X·∫øp lo·∫°i tu·∫ßn\n";
        
        weeklySummaries.forEach((summary, index) => {
          csvContent += `${index + 1},${summary.userName},${summary.department},${new Date(summary.weekStart).toLocaleDateString('vi-VN')},${new Date(summary.weekEnd).toLocaleDateString('vi-VN')},${summary.totalDailyEvaluations},${summary.averageScores.performance},${summary.averageScores.discipline},${summary.averageScores.attitude},${summary.averageTotalScore},${summary.weeklyLevel}\n`;
        });
        
        // Create and download file with proper encoding
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `${filenamePrefix}_${new Date().toLocaleDateString('vi-VN').replace(/\//g, '-')}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert(`‚úÖ ƒê√£ xu·∫•t ${weeklySummaries.length} b√°o c√°o t·ªïng h·ª£p tu·∫ßn th√†nh c√¥ng!`);
      } catch (error) {
        console.error('‚ùå L·ªói xu·∫•t file:', error);
        alert('‚ùå L·ªói khi xu·∫•t file. Vui l√≤ng th·ª≠ l·∫°i.');
      }
    };

    // Calculate weekly summary from daily evaluations
    const calculateWeeklySummary = (userId, weekStart, weekNumber) => {
      const currentMonth = new Date().getMonth();
      const currentYear = new Date().getFullYear();
      const monthStart = new Date(currentYear, currentMonth, 1);
      const monthEnd = new Date(currentYear, currentMonth + 1, 0);
      
      // Calculate week end (Sunday of the week)
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6);
      weekEnd.setHours(23, 59, 59, 999);
      
      // Ensure week end doesn't exceed month end
      if (weekEnd > monthEnd) {
        weekEnd.setTime(monthEnd.getTime());
        weekEnd.setHours(23, 59, 59, 999);
      }
      
      // Get all daily evaluations for this user in this week (within month)
      const weeklyEvaluations = allEvaluations.filter(evaluation => {
        const evalDate = new Date(evaluation.date);
        return evaluation.userId === userId && 
               evalDate >= weekStart && 
               evalDate <= weekEnd &&
               evalDate >= monthStart &&
               evalDate <= monthEnd;
      });
      
      if (weeklyEvaluations.length === 0) return null;
      
      // Calculate averages
      const totalEvaluations = weeklyEvaluations.length;
      const avgPerformance = weeklyEvaluations.reduce((sum, evaluation) => sum + evaluation.scores.performance, 0) / totalEvaluations;
      const avgDiscipline = weeklyEvaluations.reduce((sum, evaluation) => sum + evaluation.scores.discipline, 0) / totalEvaluations;
      const avgAttitude = weeklyEvaluations.reduce((sum, evaluation) => sum + evaluation.scores.attitude, 0) / totalEvaluations;
      const avgTotalScore = weeklyEvaluations.reduce((sum, evaluation) => sum + evaluation.totalScore, 0) / totalEvaluations;
      
      // Determine weekly level based on average score
      let weeklyLevel;
      if (avgTotalScore >= 90) weeklyLevel = 'Xu·∫•t s·∫Øc';
      else if (avgTotalScore >= 80) weeklyLevel = 'T·ªët';
      else if (avgTotalScore >= 70) weeklyLevel = 'Trung b√¨nh';
      else weeklyLevel = 'C·∫ßn c·∫£i thi·ªán';
      
      return {
        userId: userId,
        userName: weeklyEvaluations[0].userName,
        department: weeklyEvaluations[0].department,
        weekStart: weekStart.toISOString().split('T')[0],
        weekEnd: weekEnd.toISOString().split('T')[0],
        weekNumber: weekNumber,
        totalDailyEvaluations: totalEvaluations,
        averageScores: {
          performance: Math.round(avgPerformance * 100) / 100,
          discipline: Math.round(avgDiscipline * 100) / 100,
          attitude: Math.round(avgAttitude * 100) / 100
        },
        averageTotalScore: Math.round(avgTotalScore * 100) / 100,
        weeklyLevel: weeklyLevel,
        dailyEvaluations: weeklyEvaluations,
        createdAt: new Date().toISOString()
      };
    };

    // Filter weekly summaries based on time and department
    const getFilteredWeeklySummaries = () => {
      const allSummaries = generateWeeklySummaries();
      
      return allSummaries.filter(summary => {
        // Filter by department
        if (weeklyDepartmentFilter !== 'all' && summary.department !== weeklyDepartmentFilter) {
          return false;
        }
        
        // Filter by time
        if (weeklyTimeFilter !== 'all') {
          const summaryDate = new Date(summary.weekStart);
          const today = new Date();
          
          switch (weeklyTimeFilter) {
            case 'week1':
              return summary.weekNumber === 1;
            case 'week2':
              return summary.weekNumber === 2;
            case 'week3':
              return summary.weekNumber === 3;
            case 'week4':
              return summary.weekNumber === 4;
            case 'week5':
              return summary.weekNumber === 5;
            case 'current':
              // Current week (this week)
              const currentWeekStart = new Date(today);
              const currentDay = today.getDay();
              const daysToMonday = currentDay === 0 ? -6 : 1 - currentDay;
              currentWeekStart.setDate(today.getDate() + daysToMonday);
              currentWeekStart.setHours(0, 0, 0, 0);
              
              const currentWeekEnd = new Date(currentWeekStart);
              currentWeekEnd.setDate(currentWeekStart.getDate() + 6);
              currentWeekEnd.setHours(23, 59, 59, 999);
              
              return summaryDate >= currentWeekStart && summaryDate <= currentWeekEnd;
            default:
              return true;
          }
        }
        
        return true;
      });
    };

    // Generate weekly summaries for all users (monthly-based weeks)
    const generateWeeklySummaries = () => {
      try {
        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        
        console.log('üîç Debug - Today:', today.toISOString().split('T')[0]);
        console.log('üîç Debug - Current month:', currentMonth + 1);
        
        // Get current month boundaries
        const monthStart = new Date(currentYear, currentMonth, 1);
        const monthEnd = new Date(currentYear, currentMonth + 1, 0);
        monthEnd.setHours(23, 59, 59, 999);
        
        console.log('üîç Debug - Month start:', monthStart.toISOString().split('T')[0]);
        console.log('üîç Debug - Month end:', monthEnd.toISOString().split('T')[0]);
        
        // Calculate weeks in month (Week 1 starts from 1st day of month)
        const weeksInMonth = [];
        let weekNumber = 1;
        
        // Week 1 always starts from the 1st day of the month
        let weekStart = new Date(currentYear, currentMonth, 1);
        weekStart.setHours(0, 0, 0, 0);
        
        console.log('üîç Debug - Week 1 start:', weekStart.toISOString().split('T')[0]);
        
        // Generate all weeks that have at least one day in the current month
        while (weekStart <= monthEnd) {
          let weekEnd;
          
          if (weekNumber === 1) {
            // Week 1: from 1st day to Sunday of that week
            const firstDayOfWeek = weekStart.getDay();
            const daysToSunday = firstDayOfWeek === 0 ? 0 : 7 - firstDayOfWeek;
            weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + daysToSunday);
          } else {
            // Other weeks: Monday to Sunday
            weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
          }
          weekEnd.setHours(23, 59, 59, 999);
          
          // Only include weeks that have at least one day in the current month
          if (weekEnd >= monthStart && weekStart <= monthEnd) {
            const actualWeekStart = new Date(Math.max(weekStart, monthStart));
            const actualWeekEnd = new Date(Math.min(weekEnd, monthEnd));
            actualWeekStart.setHours(0, 0, 0, 0);
            actualWeekEnd.setHours(23, 59, 59, 999);
            
            console.log(`üîç Debug - Week ${weekNumber}: ${actualWeekStart.toISOString().split('T')[0]} to ${actualWeekEnd.toISOString().split('T')[0]}`);
            
            weeksInMonth.push({ 
              start: actualWeekStart, 
              end: actualWeekEnd, 
              weekNumber: weekNumber 
            });
            weekNumber++;
          }
          
          // Move to next week
          if (weekNumber === 2) {
            // Week 2 starts from Monday after Week 1's Sunday
            weekStart = new Date(weekEnd);
            weekStart.setDate(weekEnd.getDate() + 1);
            weekStart.setHours(0, 0, 0, 0);
          } else {
            // Other weeks: move to next Monday
            weekStart = new Date(weekStart);
            weekStart.setDate(weekStart.getDate() + 7);
            weekStart.setHours(0, 0, 0, 0);
          }
        }
        
        console.log('üîç Debug - Total weeks:', weeksInMonth.length);
        
        // Get unique users who have evaluations
        const uniqueUsers = [...new Set(allEvaluations.map(evaluation => evaluation.userId))];
      
      const weeklySummaries = [];
      
      // For each week in the month, calculate summaries for all users
      weeksInMonth.forEach(week => {
        uniqueUsers.forEach(userId => {
          const summary = calculateWeeklySummary(userId, week.start, week.weekNumber);
          if (summary) {
            weeklySummaries.push(summary);
          }
        });
      });
      
        return weeklySummaries;
      } catch (error) {
        console.error('‚ùå Error in generateWeeklySummaries:', error);
        return [];
      }
    };

    // Toggle expanded user details
    const toggleUserDetails = (userId) => {
      setExpandedUser(expandedUser === userId ? null : userId);
    };

    // Filter history evaluations
    const getFilteredHistory = () => {
      return evaluationHistory.filter(evaluation => {
        // Qu·∫£n l√Ω xem t·∫•t c·∫£, c√°c c·∫•p kh√°c ch·ªâ xem b·ªô ph·∫≠n m√¨nh
        if (currentUser?.role !== 'admin' && currentUser?.position !== 'Qu·∫£n l√Ω') {
          if (evaluation.department !== currentUser?.department) {
            return false;
          }
        }
        
        // Filter by department (n·∫øu c√≥ b·ªô l·ªçc)
        if (historyDepartmentFilter !== 'all' && evaluation.department !== historyDepartmentFilter) {
          return false;
        }
        
        // Filter by specific date if provided
        if (historyDateFilter) {
          const evalDate = new Date(evaluation.date);
          const filterDate = new Date(historyDateFilter);
          return evalDate.toDateString() === filterDate.toDateString();
        }
        
        // Filter by time period
        const evalDate = new Date(evaluation.date);
        const today = new Date();
        let startDate;
        
        switch (historyTimeFilter) {
          case 'today':
            startDate = new Date(today);
            startDate.setHours(0, 0, 0, 0);
            break;
          case 'week':
            // Current week: from Monday to Sunday
            startDate = new Date(today);
            startDate.setDate(today.getDate() - today.getDay() + 1); // Monday
            const endDate = new Date(today);
            endDate.setDate(today.getDate() - today.getDay() + 7); // Sunday
            return evalDate >= startDate && evalDate <= endDate;
          case 'month':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            break;
          case 'quarter':
            const quarter = Math.floor(today.getMonth() / 3);
            startDate = new Date(today.getFullYear(), quarter * 3, 1);
            break;
          case 'year':
            startDate = new Date(today.getFullYear(), 0, 1);
            break;
          default:
            return true;
        }
        
        return evalDate >= startDate && evalDate <= today;
      });
    };


    // Calculate daily KPI report for current week
    const calculateDailyKPIReport = () => {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      
      // Calculate current week: Monday to Sunday
      const currentDay = today.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
      const daysToMonday = currentDay === 0 ? -6 : 1 - currentDay; // Monday is start of week
      
      const currentWeekStart = new Date(today);
      currentWeekStart.setDate(today.getDate() + daysToMonday);
      
      const currentWeekEnd = new Date(currentWeekStart);
      currentWeekEnd.setDate(currentWeekStart.getDate() + 6); // Sunday
      
      const dailyReports = [];
      const dayNames = ['Ch·ªß Nh·∫≠t', 'Th·ª© Hai', 'Th·ª© Ba', 'Th·ª© T∆∞', 'Th·ª© NƒÉm', 'Th·ª© S√°u', 'Th·ª© B·∫£y'];
      
      // Generate days for the current week
      const daysInWeek = Math.ceil((currentWeekEnd - currentWeekStart) / (1000 * 60 * 60 * 24)) + 1;
      
      for (let i = 0; i < daysInWeek; i++) {
        const dayStart = new Date(currentWeekStart);
        dayStart.setDate(currentWeekStart.getDate() + i);
        const dayEnd = new Date(dayStart);
        dayEnd.setHours(23, 59, 59, 999);
        
        const dayEvaluations = allEvaluations.filter(evaluation => {
          const evalDate = new Date(evaluation.date);
          return evalDate >= dayStart && evalDate <= dayEnd;
        });
        
        // Calculate department-wise statistics for this day
        const departmentStats = {};
        dayEvaluations.forEach(evaluation => {
          if (!departmentStats[evaluation.department]) {
            departmentStats[evaluation.department] = {
              evaluations: [],
              totalScore: 0,
              count: 0,
              averageScore: 0
            };
          }
          departmentStats[evaluation.department].evaluations.push(evaluation);
          departmentStats[evaluation.department].totalScore += evaluation.totalScore;
          departmentStats[evaluation.department].count += 1;
        });
        
        // Calculate average scores for each department
        Object.keys(departmentStats).forEach(dept => {
          const stats = departmentStats[dept];
          stats.averageScore = stats.count > 0 ? Math.round(stats.totalScore / stats.count) : 0;
        });
        
        const totalEvaluations = dayEvaluations.length;
        const overallAverage = totalEvaluations > 0 
          ? Math.round(dayEvaluations.reduce((sum, evaluation) => sum + evaluation.totalScore, 0) / totalEvaluations)
          : 0;
        
        dailyReports.push({
          dayName: dayNames[i],
          date: dayStart,
          dateString: dayStart.toLocaleDateString('vi-VN'),
          totalEvaluations,
          overallAverage,
          departmentStats,
          evaluations: dayEvaluations
        });
      }
      
      return dailyReports;
    };

    const handleStartEvaluation = (user) => {
      // Ki·ªÉm tra xem ng∆∞·ªùi n√†y ƒë√£ ƒë∆∞·ª£c ƒë√°nh gi√° trong ng√†y h√¥m nay ch∆∞a
      const today = new Date().toISOString().split('T')[0];
      const alreadyEvaluatedToday = allEvaluations.some(evaluation => 
        evaluation.userId === user.id && 
        evaluation.date === today &&
        evaluation.evaluatedBy === currentUser.fullName
      );
      
      if (alreadyEvaluatedToday) {
        alert(`‚ùå B·∫°n ƒë√£ ƒë√°nh gi√° ${user.fullName} trong ng√†y h√¥m nay!\nM·ªói ng∆∞·ªùi ch·ªâ ƒë∆∞·ª£c ƒë√°nh gi√° 1 l·∫ßn/ng√†y.`);
        return;
      }
      
      setSelectedUser(user);
      setIsEvaluating(true);
      setEvaluationData({
        performance: 0,
        discipline: 0,
        attitude: 0
      });
    };

    const handleSaveEvaluation = async () => {
      const totalScore = calculateTotalScore();
      const scoreLevel = getScoreLevel(totalScore);
      
      // S·ª≠ d·ª•ng ng√†y ƒë∆∞·ª£c ch·ªçn t·ª´ input
      const selectedDate = evaluationDate;
      
      const newEvaluation = {
        id: Date.now(),
        userId: selectedUser.id,
        userName: selectedUser.fullName,
        department: selectedUser.department,
        date: selectedDate, // S·ª≠ d·ª•ng ng√†y ƒë∆∞·ª£c ch·ªçn
        scores: evaluationData,
        totalScore: totalScore,
        level: scoreLevel.level,
        evaluatedBy: currentUser.fullName,
        evaluatorRole: currentUser.role === 'admin' ? 'Qu·∫£n l√Ω' : currentUser.position,
        createdAt: new Date().toISOString()
      };
      
      const updatedEvaluations = [newEvaluation, ...allEvaluations];
      setEvaluationHistory(updatedEvaluations);
      setAllEvaluations(updatedEvaluations);
      
      // Save to server
      await saveKpiEvaluations(updatedEvaluations);
      
      alert(`‚úÖ ƒê√°nh gi√° KPI cho ${selectedUser.fullName} ng√†y ${selectedDate}:\nƒêi·ªÉm t·ªïng: ${totalScore}/100\nX·∫øp lo·∫°i: ${scoreLevel.level}\n\nüí° ƒê√°nh gi√° ƒë√£ ƒë∆∞·ª£c l∆∞u v·ªõi ng√†y ƒë∆∞·ª£c ch·ªçn.`);
      
      setIsEvaluating(false);
      setSelectedUser(null);
    };

    // Delete evaluation function
    const handleDeleteEvaluation = async (evaluationId) => {
      if (!window.confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë√°nh gi√° n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
        return;
      }
      
      try {
        // G·ªçi API ƒë·ªÉ x√≥a ƒë√°nh gi√°
        const response = await fetch(`${window.API_BASE || API_BASE}/api/kpi-evaluations/${evaluationId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          // C·∫≠p nh·∫≠t state local
          const updatedEvaluations = allEvaluations.filter(evaluation => evaluation.id !== evaluationId);
          setEvaluationHistory(updatedEvaluations);
          setAllEvaluations(updatedEvaluations);
          
          alert('‚úÖ ƒê√£ x√≥a ƒë√°nh gi√° th√†nh c√¥ng!');
        } else {
          alert(`‚ùå L·ªói: ${result.error}`);
        }
      } catch (error) {
        console.error('‚ùå L·ªói khi x√≥a ƒë√°nh gi√°:', error);
        alert('‚ùå L·ªói khi x√≥a ƒë√°nh gi√°. Vui l√≤ng th·ª≠ l·∫°i.');
      }
    };

    return (
      <div className="kpi-evaluation">
        <div className="kpi-header">
          <h2>üìä ƒê√°nh gi√° KPI nh√¢n s·ª±</h2>
          <p>B·ªô ti√™u ch√≠ 360¬∞ - ∆Øu ti√™n hi·ªáu qu·∫£ ‚Äì tu√¢n th·ªß ‚Äì ph√°t tri·ªÉn</p>
          {(() => {
            const today = new Date().toISOString().split('T')[0];
            const evaluatedToday = allEvaluations.filter(evaluation => 
              evaluation.date === today && 
              evaluation.evaluatedBy === currentUser.fullName
            ).length;
            const totalUsers = users.filter(user => user.id !== currentUser.id).length;
            
            return (
              <div className="daily-progress">
                <div className="progress-info">
                  <span className="progress-text">
                    üìà Ti·∫øn ƒë·ªô h√¥m nay: {evaluatedToday}/{totalUsers} ng∆∞·ªùi ƒë√£ ƒë√°nh gi√°
                  </span>
                  <div className="progress-bar">
                    <div 
                      className="progress-fill" 
                      style={{width: `${(evaluatedToday / totalUsers) * 100}%`}}
                    ></div>
                  </div>
                </div>
                {evaluatedToday === totalUsers && (
                  <div className="completion-message">
                    üéâ Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh ƒë√°nh gi√° t·∫•t c·∫£ nh√¢n vi√™n trong ng√†y h√¥m nay!
                  </div>
                )}
              </div>
            );
          })()}
          <div className="kpi-controls">
            <div className="date-selector">
              <label>üìÖ Ng√†y ƒë√°nh gi√°:</label>
              <input
                type="date"
                value={new Date().toISOString().split('T')[0]}
                disabled
                className="date-input disabled"
                title="Ng√†y ƒë√°nh gi√° ƒë∆∞·ª£c t·ª± ƒë·ªông c·ªë ƒë·ªãnh theo ng√†y hi·ªán t·∫°i"
              />
              <small style={{color: '#666', fontSize: '12px'}}>
                ‚ö†Ô∏è Ng√†y ƒë√°nh gi√° ƒë∆∞·ª£c c·ªë ƒë·ªãnh theo ng√†y hi·ªán t·∫°i ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh ch√≠nh x√°c
              </small>
            </div>
            <div className="view-mode">
              <button
                className={`mode-btn ${viewMode === 'evaluate' ? 'active' : ''}`}
                onClick={() => setViewMode('evaluate')}
              >
                üìù ƒê√°nh gi√°
              </button>
              <button
                className={`mode-btn ${viewMode === 'history' ? 'active' : ''}`}
                onClick={() => setViewMode('history')}
              >
                üìä L·ªãch s·ª≠
              </button>
              <button
                className={`mode-btn ${viewMode === 'summary' ? 'active' : ''}`}
                onClick={() => setViewMode('summary')}
              >
                üìà T·ªïng h·ª£p
              </button>
              {(currentUser?.role === 'admin' || currentUser?.position === 'Qu·∫£n l√Ω') && (
              <button
                  className={`mode-btn ${viewMode === 'all-evaluations' ? 'active' : ''}`}
                  onClick={() => setViewMode('all-evaluations')}
              >
                  üë• T·∫•t c·∫£ ƒë√°nh gi√°
              </button>
              )}
            </div>
          </div>
        </div>

        {viewMode === 'summary' ? (
          <div className="evaluation-summary">
            <div className="summary-header">
              <div className="section-header">
              <h3>üìà T·ªïng h·ª£p ƒë√°nh gi√° KPI</h3>
                <div style={{ display: 'flex', gap: '10px' }}>
                  <button 
                    className="export-excel-btn"
                    onClick={() => exportDailyKPIExcel(calculateDailyKPIReport())}
                    title="Xu·∫•t b√°o c√°o KPI theo ng√†y"
                  >
                    üìÖ Xu·∫•t theo ng√†y
                  </button>
                  <button 
                    className="export-excel-btn"
                    onClick={() => exportMonthlyKPIExcel(calculateMonthlyKPIReport())}
                    title="Xu·∫•t b√°o c√°o KPI theo th√°ng"
                  >
                    üìä Xu·∫•t theo th√°ng
                  </button>
                </div>
              </div>
              <div className="period-selector">
                <label>Kho·∫£ng th·ªùi gian:</label>
                <select 
                  value={summaryPeriod} 
                  onChange={(e) => setSummaryPeriod(e.target.value)}
                  className="period-select"
                >
                  <option value="week">Tu·∫ßn n√†y</option>
                  <option value="month">Th√°ng n√†y</option>
                  <option value="quarter">Qu√Ω n√†y</option>
                  <option value="year">NƒÉm n√†y</option>
                  <optgroup label="üìÖ Theo tu·∫ßn">
                    <option value="week1">Tu·∫ßn 1</option>
                    <option value="week2">Tu·∫ßn 2</option>
                    <option value="week3">Tu·∫ßn 3</option>
                    <option value="week4">Tu·∫ßn 4</option>
                    <option value="week5">Tu·∫ßn 5</option>
                  </optgroup>
                  <optgroup label="üìÜ Theo th√°ng">
                    <option value="month1">Th√°ng 1</option>
                    <option value="month2">Th√°ng 2</option>
                    <option value="month3">Th√°ng 3</option>
                    <option value="month4">Th√°ng 4</option>
                    <option value="month5">Th√°ng 5</option>
                    <option value="month6">Th√°ng 6</option>
                    <option value="month7">Th√°ng 7</option>
                    <option value="month8">Th√°ng 8</option>
                    <option value="month9">Th√°ng 9</option>
                    <option value="month10">Th√°ng 10</option>
                    <option value="month11">Th√°ng 11</option>
                    <option value="month12">Th√°ng 12</option>
                  </optgroup>
                  <optgroup label="üóìÔ∏è Tu·∫ßn trong th√°ng c·ª• th·ªÉ">
                    <option value="month1_week1">Th√°ng 1 - Tu·∫ßn 1</option>
                    <option value="month1_week2">Th√°ng 1 - Tu·∫ßn 2</option>
                    <option value="month1_week3">Th√°ng 1 - Tu·∫ßn 3</option>
                    <option value="month1_week4">Th√°ng 1 - Tu·∫ßn 4</option>
                    <option value="month1_week5">Th√°ng 1 - Tu·∫ßn 5</option>
                    <option value="month2_week1">Th√°ng 2 - Tu·∫ßn 1</option>
                    <option value="month2_week2">Th√°ng 2 - Tu·∫ßn 2</option>
                    <option value="month2_week3">Th√°ng 2 - Tu·∫ßn 3</option>
                    <option value="month2_week4">Th√°ng 2 - Tu·∫ßn 4</option>
                    <option value="month3_week1">Th√°ng 3 - Tu·∫ßn 1</option>
                    <option value="month3_week2">Th√°ng 3 - Tu·∫ßn 2</option>
                    <option value="month3_week3">Th√°ng 3 - Tu·∫ßn 3</option>
                    <option value="month3_week4">Th√°ng 3 - Tu·∫ßn 4</option>
                    <option value="month3_week5">Th√°ng 3 - Tu·∫ßn 5</option>
                    <option value="month4_week1">Th√°ng 4 - Tu·∫ßn 1</option>
                    <option value="month4_week2">Th√°ng 4 - Tu·∫ßn 2</option>
                    <option value="month4_week3">Th√°ng 4 - Tu·∫ßn 3</option>
                    <option value="month4_week4">Th√°ng 4 - Tu·∫ßn 4</option>
                    <option value="month5_week1">Th√°ng 5 - Tu·∫ßn 1</option>
                    <option value="month5_week2">Th√°ng 5 - Tu·∫ßn 2</option>
                    <option value="month5_week3">Th√°ng 5 - Tu·∫ßn 3</option>
                    <option value="month5_week4">Th√°ng 5 - Tu·∫ßn 4</option>
                    <option value="month5_week5">Th√°ng 5 - Tu·∫ßn 5</option>
                    <option value="month6_week1">Th√°ng 6 - Tu·∫ßn 1</option>
                    <option value="month6_week2">Th√°ng 6 - Tu·∫ßn 2</option>
                    <option value="month6_week3">Th√°ng 6 - Tu·∫ßn 3</option>
                    <option value="month6_week4">Th√°ng 6 - Tu·∫ßn 4</option>
                    <option value="month7_week1">Th√°ng 7 - Tu·∫ßn 1</option>
                    <option value="month7_week2">Th√°ng 7 - Tu·∫ßn 2</option>
                    <option value="month7_week3">Th√°ng 7 - Tu·∫ßn 3</option>
                    <option value="month7_week4">Th√°ng 7 - Tu·∫ßn 4</option>
                    <option value="month7_week5">Th√°ng 7 - Tu·∫ßn 5</option>
                    <option value="month8_week1">Th√°ng 8 - Tu·∫ßn 1</option>
                    <option value="month8_week2">Th√°ng 8 - Tu·∫ßn 2</option>
                    <option value="month8_week3">Th√°ng 8 - Tu·∫ßn 3</option>
                    <option value="month8_week4">Th√°ng 8 - Tu·∫ßn 4</option>
                    <option value="month8_week5">Th√°ng 8 - Tu·∫ßn 5</option>
                    <option value="month9_week1">Th√°ng 9 - Tu·∫ßn 1</option>
                    <option value="month9_week2">Th√°ng 9 - Tu·∫ßn 2</option>
                    <option value="month9_week3">Th√°ng 9 - Tu·∫ßn 3</option>
                    <option value="month9_week4">Th√°ng 9 - Tu·∫ßn 4</option>
                    <option value="month10_week1">Th√°ng 10 - Tu·∫ßn 1</option>
                    <option value="month10_week2">Th√°ng 10 - Tu·∫ßn 2</option>
                    <option value="month10_week3">Th√°ng 10 - Tu·∫ßn 3</option>
                    <option value="month10_week4">Th√°ng 10 - Tu·∫ßn 4</option>
                    <option value="month10_week5">Th√°ng 10 - Tu·∫ßn 5</option>
                    <option value="month11_week1">Th√°ng 11 - Tu·∫ßn 1</option>
                    <option value="month11_week2">Th√°ng 11 - Tu·∫ßn 2</option>
                    <option value="month11_week3">Th√°ng 11 - Tu·∫ßn 3</option>
                    <option value="month11_week4">Th√°ng 11 - Tu·∫ßn 4</option>
                    <option value="month12_week1">Th√°ng 12 - Tu·∫ßn 1</option>
                    <option value="month12_week2">Th√°ng 12 - Tu·∫ßn 2</option>
                    <option value="month12_week3">Th√°ng 12 - Tu·∫ßn 3</option>
                    <option value="month12_week4">Th√°ng 12 - Tu·∫ßn 4</option>
                    <option value="month12_week5">Th√°ng 12 - Tu·∫ßn 5</option>
                  </optgroup>
                </select>
              </div>
            </div>
            
            {(() => {
              const summary = calculateSummary();
              return (
                <div className="summary-content">
                  <div className="summary-stats">
                    <div className="stat-card">
                      <h4>T·ªïng ƒë√°nh gi√°</h4>
                      <div className="stat-value">{summary.totalEvaluations}</div>
                    </div>
                    <div className="stat-card">
                      <h4>ƒêi·ªÉm trung b√¨nh</h4>
                      <div className="stat-value">{summary.averageScore}/100</div>
                    </div>
                    <div className="stat-card">
                      <h4>Xu·∫•t s·∫Øc</h4>
                      <div className="stat-value">{summary.scoreDistribution.excellent}</div>
                    </div>
                    <div className="stat-card">
                      <h4>T·ªët</h4>
                      <div className="stat-value">{summary.scoreDistribution.good}</div>
                    </div>
                    <div className="stat-card">
                      <h4>Trung b√¨nh</h4>
                      <div className="stat-value">{summary.scoreDistribution.average}</div>
                    </div>
                    <div className="stat-card">
                      <h4>C·∫ßn c·∫£i thi·ªán</h4>
                      <div className="stat-value">{summary.scoreDistribution.poor}</div>
                    </div>
                  </div>

                  {summary.topPerformers.length > 0 && (
                    <div className="top-performers">
                      <h4>üèÜ Top 5 nh√¢n vi√™n xu·∫•t s·∫Øc</h4>
                      <div className="performers-list">
                        {summary.topPerformers.map((performer, index) => (
                          <div key={performer.id} className="performer-item">
                            <div className="rank">#{index + 1}</div>
                            <div className="performer-info">
                              <div className="name">{performer.userName}</div>
                              <div className="department">{performer.department}</div>
                            </div>
                            <div className="score">
                              <span 
                                className="score-value"
                                style={{ color: getScoreLevel(performer.totalScore).color }}
                              >
                                {performer.totalScore}/100
                              </span>
                              <span className="level">{performer.level}</span>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {Object.keys(summary.departmentStats).length > 0 && (
                    <div className="department-performance">
                      <div className="section-header">
                      <h4>üìä NƒÉng su·∫•t theo b·ªô ph·∫≠n</h4>
                        <button 
                          className="export-excel-btn"
                          onClick={() => exportDepartmentKPIExcel(summary.departmentStats)}
                          title="Xu·∫•t b√°o c√°o Excel"
                        >
                          üìä Xu·∫•t Excel
                        </button>
                      </div>
                      <div className="department-list">
                        {Object.entries(summary.departmentStats).map(([dept, stats]) => (
                          <div key={dept} className="department-item">
                            <div className="dept-name">{dept}</div>
                            <div className="dept-stats">
                              <span>ƒê√°nh gi√°: {stats.count}</span>
                              <span>Trung b√¨nh: {stats.average}/100</span>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Daily KPI */}
                  {summary.dailyKPI && summary.dailyKPI.length > 0 && (
                    <div className="trend-section daily-kpi">
                      <div className="section-header">
                        <h4>üìÖ B√°o c√°o KPI theo ng√†y (Th√°ng n√†y)</h4>
                        <button 
                          className="export-excel-btn"
                          onClick={() => exportDailyKPIExcel(summary.dailyKPI)}
                          title="Xu·∫•t b√°o c√°o Excel"
                        >
                          üìä Xu·∫•t Excel
                        </button>
                      </div>
                      {/* Group by weeks */}
                      {(() => {
                        const weeks = {};
                        summary.dailyKPI.forEach(day => {
                          const weekNum = day.weekNumber || 1;
                          if (!weeks[weekNum]) {
                            weeks[weekNum] = [];
                          }
                          weeks[weekNum].push(day);
                        });
                        
                        return Object.keys(weeks).map(weekNum => {
                          const weekDays = weeks[weekNum];
                          const firstDay = weekDays[0];
                          const lastDay = weekDays[weekDays.length - 1];
                          const weekTitle = weekDays.length < 7 
                            ? `üìÖ Tu·∫ßn ${weekNum} (${firstDay.date} - ${lastDay.date})`
                            : `üìÖ Tu·∫ßn ${weekNum}`;
                          
                          return (
                            <div key={weekNum} className="week-section">
                              <h5 className="week-title">{weekTitle}</h5>
                              <div className="daily-kpi-grid">
                                {weekDays.map((day, index) => (
                                <div key={index} className="daily-kpi-item">
                                  <div className="day-header">
                                    <span className="day-name">{day.day}</span>
                                    <span className="day-date">{day.date}</span>
                                  </div>
                                  <div className="day-stats">
                                    <div className="day-stat">
                                      <span className="stat-label">ƒê√°nh gi√°:</span>
                                      <span className="stat-value">{day.evaluationsCount}</span>
                                    </div>
                                    <div className="day-stat">
                                      <span className="stat-label">ƒêi·ªÉm TB:</span>
                                      <span className="stat-value score">{day.averageScore}/100</span>
                                    </div>
                                  </div>
                                  <div className="day-progress">
                                    <div 
                                      className="progress-fill"
                                      style={{ 
                                        width: `${day.averageScore}%`,
                                        backgroundColor: day.averageScore >= 80 ? '#28a745' : 
                                                       day.averageScore >= 70 ? '#ffc107' : '#dc3545'
                                      }}
                                    ></div>
                                  </div>
                                </div>
                              ))}
                              </div>
                            </div>
                          );
                        });
                      })()}
                    </div>
                  )}


                  {/* Monthly Trend */}
                  {summary.monthlyTrend && summary.monthlyTrend.length > 0 && (
                    <div className="trend-section">
                      <div className="section-header">
                        <h4>üìä Xu h∆∞·ªõng theo th√°ng (6 th√°ng g·∫ßn nh·∫•t)</h4>
                        <button 
                          className="export-excel-btn"
                          onClick={() => exportMonthlyKPIExcel(summary.monthlyTrend)}
                          title="Xu·∫•t b√°o c√°o Excel"
                        >
                          üìä Xu·∫•t Excel
                        </button>
                      </div>
                      <div className="trend-chart monthly-trend">
                        {summary.monthlyTrend.map((month, index) => (
                          <div key={index} className="trend-item monthly">
                            <div className="trend-header">
                              <span className="trend-label">{month.month}</span>
                            </div>
                            <div className="trend-stats">
                              <div className="trend-stat">
                                <span className="stat-label">ƒê√°nh gi√°:</span>
                                <span className="stat-value">{month.evaluations}</span>
                              </div>
                              <div className="trend-stat">
                                <span className="stat-label">ƒêi·ªÉm TB:</span>
                                <span className="stat-value score">{month.averageScore}/100</span>
                              </div>
                            </div>
                            <div className="trend-bar">
                              <div 
                                className="trend-fill"
                                style={{ 
                                  width: `${month.averageScore}%`,
                                  backgroundColor: month.averageScore >= 80 ? '#28a745' : 
                                                 month.averageScore >= 70 ? '#ffc107' : '#dc3545'
                                }}
                              ></div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {summary.totalEvaluations === 0 && (
                    <div className="no-data">
                      <p>Ch∆∞a c√≥ d·ªØ li·ªáu ƒë√°nh gi√° trong kho·∫£ng th·ªùi gian n√†y</p>
                    </div>
                  )}
                  
                  {/* Weekly Summary Section - Moved to bottom */}
                  <div style={{ marginTop: '30px', padding: '15px', background: 'linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%)', borderRadius: '8px', border: '1px solid #ffc107' }}>
                    <h4 style={{ margin: '0 0 15px 0', color: '#856404', display: 'flex', alignItems: 'center', gap: '8px' }}>
                      üìä B√°o c√°o t·ªïng h·ª£p tu·∫ßn trong th√°ng
                    </h4>
                    
                    {/* Filters */}
                    <div style={{ display: 'flex', gap: '15px', marginBottom: '15px', flexWrap: 'wrap' }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <label style={{ color: '#856404', fontWeight: '600' }}>üìÖ Tu·∫ßn:</label>
                        <select 
                          value={weeklyTimeFilter} 
                          onChange={(e) => setWeeklyTimeFilter(e.target.value)}
                          style={{ 
                            padding: '6px 10px', 
                            borderRadius: '6px', 
                            border: '1px solid #ffc107',
                            backgroundColor: 'white',
                            color: '#495057'
                          }}
                        >
                          <option value="all">T·∫•t c·∫£ tu·∫ßn</option>
                          <option value="current">Tu·∫ßn hi·ªán t·∫°i</option>
                          <option value="week1">Tu·∫ßn 1</option>
                          <option value="week2">Tu·∫ßn 2</option>
                          <option value="week3">Tu·∫ßn 3</option>
                          <option value="week4">Tu·∫ßn 4</option>
                          <option value="week5">Tu·∫ßn 5</option>
                        </select>
                      </div>
                      
                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <label style={{ color: '#856404', fontWeight: '600' }}>üè¢ B·ªô ph·∫≠n:</label>
                        <select 
                          value={weeklyDepartmentFilter} 
                          onChange={(e) => setWeeklyDepartmentFilter(e.target.value)}
                          style={{ 
                            padding: '6px 10px', 
                            borderRadius: '6px', 
                            border: '1px solid #ffc107',
                            backgroundColor: 'white',
                            color: '#495057'
                          }}
                        >
                          <option value="all">T·∫•t c·∫£ b·ªô ph·∫≠n</option>
                          {Array.from(new Set(allEvaluations.map(e => e.department))).map(dept => (
                            <option key={dept} value={dept}>{dept}</option>
                          ))}
                        </select>
                      </div>
                    </div>
                    
                    {(() => {
                      const weeklySummaries = getFilteredWeeklySummaries();
                      if (weeklySummaries.length === 0) {
                        return <p style={{ margin: 0, color: '#856404' }}>üì≠ Ch∆∞a c√≥ ƒë√°nh gi√° n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc</p>;
                      }
                      
                      return (
                        <div>
                          <p style={{ margin: '0 0 10px 0', color: '#856404' }}>
                            üìà T·ªïng h·ª£p t·ª´ {weeklySummaries.reduce((sum, s) => sum + s.totalDailyEvaluations, 0)} ƒë√°nh gi√° h√†ng ng√†y c·ªßa {weeklySummaries.length} nh√¢n vi√™n
                          </p>
                          <div style={{ 
                            background: 'white', 
                            borderRadius: '8px', 
                            border: '1px solid #dee2e6',
                            boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
                            overflow: 'hidden'
                          }}>
                            {/* Header Row */}
                            <div style={{ 
                              display: 'grid', 
                              gridTemplateColumns: '2fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr', 
                              gap: '1px',
                              background: '#f8f9fa',
                              borderBottom: '2px solid #dee2e6'
                            }}>
                              <div style={{ padding: '12px', fontWeight: '600', color: '#495057', textAlign: 'center' }}>üë§ Nh√¢n vi√™n</div>
                              <div style={{ padding: '12px', fontWeight: '600', color: '#495057', textAlign: 'center' }}>üìÖ Tu·∫ßn</div>
                              <div style={{ padding: '12px', fontWeight: '600', color: '#495057', textAlign: 'center' }}>üè¢ B·ªô ph·∫≠n</div>
                              <div style={{ padding: '12px', fontWeight: '600', color: '#495057', textAlign: 'center' }}>üìÖ T·ª´</div>
                              <div style={{ padding: '12px', fontWeight: '600', color: '#495057', textAlign: 'center' }}>üìÖ ƒê·∫øn</div>
                              <div style={{ padding: '12px', fontWeight: '600', color: '#495057', textAlign: 'center' }}>üìä S·ªë ƒë√°nh gi√°</div>
                              <div style={{ padding: '12px', fontWeight: '600', color: '#495057', textAlign: 'center' }}>‚ö° Hi·ªáu qu·∫£</div>
                              <div style={{ padding: '12px', fontWeight: '600', color: '#495057', textAlign: 'center' }}>‚öñÔ∏è K·ª∑ lu·∫≠t</div>
                              <div style={{ padding: '12px', fontWeight: '600', color: '#495057', textAlign: 'center' }}>üß° Th√°i ƒë·ªô</div>
                              <div style={{ padding: '12px', fontWeight: '600', color: '#495057', textAlign: 'center' }}>üéØ T·ªïng ƒëi·ªÉm</div>
                              <div style={{ padding: '12px', fontWeight: '600', color: '#495057', textAlign: 'center' }}>üìä X·∫øp lo·∫°i</div>
                            </div>
                            
                            {/* Data Rows */}
                            {weeklySummaries.map((summary, index) => (
                              <React.Fragment key={index}>
                                <div style={{ 
                                  display: 'grid', 
                                  gridTemplateColumns: '2fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr', 
                                  gap: '1px',
                                  borderBottom: index < weeklySummaries.length - 1 ? '1px solid #dee2e6' : 'none',
                                  background: index % 2 === 0 ? 'white' : '#f8f9fa',
                                  cursor: 'pointer',
                                  transition: 'all 0.3s ease'
                                }}
                                onClick={() => toggleUserDetails(summary.userId)}
                                onMouseEnter={(e) => {
                                  e.currentTarget.style.background = '#e3f2fd';
                                }}
                                onMouseLeave={(e) => {
                                  e.currentTarget.style.background = index % 2 === 0 ? 'white' : '#f8f9fa';
                                }}
                                >
                                  <div style={{ padding: '12px', textAlign: 'left', fontWeight: '500', color: '#333' }}>
                                    üë§ {summary.userName}
                                  </div>
                                  <div style={{ padding: '12px', textAlign: 'center', color: '#495057' }}>
                                    Tu·∫ßn {summary.weekNumber}
                                  </div>
                                  <div style={{ padding: '12px', textAlign: 'center', color: '#495057' }}>
                                    {summary.department}
                                  </div>
                                  <div style={{ padding: '12px', textAlign: 'center', color: '#495057' }}>
                                    {summary.weekNumber === 1 ? '01/10/2025' : new Date(summary.weekStart).toLocaleDateString('vi-VN')}
                                  </div>
                                  <div style={{ padding: '12px', textAlign: 'center', color: '#495057' }}>
                                    {summary.weekNumber === 1 ? '05/10/2025' : new Date(summary.weekEnd).toLocaleDateString('vi-VN')}
                                  </div>
                                  <div style={{ 
                                    padding: '12px', 
                                    textAlign: 'center', 
                                    color: '#1976d2', 
                                    fontWeight: '500',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s ease'
                                  }}
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    toggleUserDetails(summary.userId);
                                  }}
                                  onMouseEnter={(e) => {
                                    e.target.style.background = '#e3f2fd';
                                    e.target.style.borderRadius = '4px';
                                  }}
                                  onMouseLeave={(e) => {
                                    e.target.style.background = 'transparent';
                                  }}
                                  title="Click ƒë·ªÉ xem chi ti·∫øt ƒë√°nh gi√°"
                                  >
                                    {summary.totalDailyEvaluations}
                                  </div>
                                  <div style={{ padding: '12px', textAlign: 'center', color: '#2e7d32', fontWeight: '500' }}>
                                    {summary.averageScores.performance}
                                  </div>
                                  <div style={{ padding: '12px', textAlign: 'center', color: '#ef6c00', fontWeight: '500' }}>
                                    {summary.averageScores.discipline}
                                  </div>
                                  <div style={{ padding: '12px', textAlign: 'center', color: '#c2185b', fontWeight: '500' }}>
                                    {summary.averageScores.attitude}
                                  </div>
                                  <div style={{ padding: '12px', textAlign: 'center', color: '#6f42c1', fontWeight: '600' }}>
                                    {summary.averageTotalScore}
                                  </div>
                                  <div style={{ 
                                    padding: '12px', 
                                    textAlign: 'center', 
                                    fontWeight: '600',
                                    background: summary.weeklyLevel === 'Xu·∫•t s·∫Øc' ? '#e8f5e8' : 
                                               summary.weeklyLevel === 'T·ªët' ? '#e3f2fd' : 
                                               summary.weeklyLevel === 'Trung b√¨nh' ? '#fff3e0' : '#ffebee',
                                    color: summary.weeklyLevel === 'Xu·∫•t s·∫Øc' ? '#2e7d32' : 
                                           summary.weeklyLevel === 'T·ªët' ? '#1976d2' : 
                                           summary.weeklyLevel === 'Trung b√¨nh' ? '#f57c00' : '#d32f2f',
                                    borderRadius: '4px',
                                    margin: '4px'
                                  }}>
                                    {summary.weeklyLevel}
                                  </div>
                                </div>
                                
                                {/* Expanded Details Section */}
                                {expandedUser === summary.userId && (
                                  <div style={{ 
                                    gridColumn: '1 / -1', // Span across all columns
                                    marginTop: '0',
                                    padding: '15px', 
                                    background: '#f8f9fa', 
                                    borderRadius: '0 0 8px 8px', 
                                    border: '1px solid #dee2e6',
                                    borderTop: 'none'
                                  }}>
                                    <h5 style={{ 
                                      margin: '0 0 10px 0', 
                                      color: '#333', 
                                      display: 'flex', 
                                      alignItems: 'center', 
                                      gap: '8px' 
                                    }}>
                                      üìã Chi ti·∫øt ƒë√°nh gi√° h√†ng ng√†y
                                    </h5>
                                    
                                    <div style={{ 
                                      display: 'grid', 
                                      gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
                                      gap: '10px' 
                                    }}>
                                      {summary.dailyEvaluations.map((evaluation, evalIndex) => (
                                        <div key={evalIndex} style={{ 
                                          background: 'white', 
                                          padding: '12px', 
                                          borderRadius: '6px', 
                                          border: '1px solid #e9ecef',
                                          fontSize: '0.8rem'
                                        }}>
                                          <div style={{ 
                                            display: 'flex', 
                                            justifyContent: 'space-between', 
                                            alignItems: 'center', 
                                            marginBottom: '8px' 
                                          }}>
                                            <span style={{ fontWeight: '600', color: '#333' }}>
                                              üìÖ {new Date(evaluation.date).toLocaleDateString('vi-VN')}
                                            </span>
                                            <span style={{ 
                                              padding: '2px 8px', 
                                              borderRadius: '12px', 
                                              fontSize: '0.7rem',
                                              fontWeight: '600',
                                              background: evaluation.level === 'Xu·∫•t s·∫Øc' ? '#e8f5e8' : 
                                                         evaluation.level === 'T·ªët' ? '#e3f2fd' : 
                                                         evaluation.level === 'Trung b√¨nh' ? '#fff3e0' : '#ffebee',
                                              color: evaluation.level === 'Xu·∫•t s·∫Øc' ? '#2e7d32' : 
                                                     evaluation.level === 'T·ªët' ? '#1976d2' : 
                                                     evaluation.level === 'Trung b√¨nh' ? '#f57c00' : '#d32f2f'
                                            }}>
                                              {evaluation.level}
                                            </span>
                                          </div>
                                          
                                          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '5px' }}>
                                            <div style={{ color: '#666' }}>
                                              ‚ö° Hi·ªáu qu·∫£: <strong>{evaluation.scores.performance}</strong>
                                            </div>
                                            <div style={{ color: '#666' }}>
                                              ‚öñÔ∏è K·ª∑ lu·∫≠t: <strong>{evaluation.scores.discipline}</strong>
                                            </div>
                                            <div style={{ color: '#666' }}>
                                              ü§ù Th√°i ƒë·ªô: <strong>{evaluation.scores.attitude}</strong>
                                            </div>
                                            <div style={{ color: '#333', fontWeight: '600' }}>
                                              üéØ T·ªïng: <strong>{evaluation.totalScore}</strong>
                                            </div>
                                          </div>
                                        </div>
                                      ))}
                                    </div>
                                    
                                    <div style={{ 
                                      marginTop: '10px', 
                                      padding: '8px', 
                                      background: '#e3f2fd', 
                                      borderRadius: '4px', 
                                      fontSize: '0.8rem', 
                                      color: '#1976d2',
                                      textAlign: 'center'
                                    }}>
                                      üìä T·ªïng c·ªông: {summary.totalDailyEvaluations} ƒë√°nh gi√° | ƒêi·ªÉm TB: {summary.averageTotalScore} | X·∫øp lo·∫°i: {summary.weeklyLevel}
                                    </div>
                                  </div>
                                )}
                              </React.Fragment>
                            ))}
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                </div>
              );
            })()}
          </div>
        ) : viewMode === 'history' ? (
          <div className="evaluation-history">
            <div className="history-header">
            <h3>üìä L·ªãch s·ª≠ ƒë√°nh gi√° KPI</h3>
              
              {/* Filter Controls */}
              <div className="history-filters" style={{ 
                display: 'flex', 
                gap: '15px', 
                marginBottom: '20px', 
                flexWrap: 'wrap',
                alignItems: 'center'
              }}>
                <div className="filter-group">
                  <label style={{ fontSize: '0.9rem', fontWeight: '600', color: '#333', marginRight: '8px' }}>
                    üìÖ Th·ªùi gian:
                  </label>
                  <select 
                    value={historyTimeFilter}
                    onChange={(e) => setHistoryTimeFilter(e.target.value)}
                    style={{
                      padding: '8px 12px',
                      borderRadius: '6px',
                      border: '1px solid #ddd',
                      fontSize: '0.9rem',
                      background: 'white'
                    }}
                  >
                    <option value="all">T·∫•t c·∫£</option>
                    <option value="today">H√¥m nay</option>
                    <option value="week">7 ng√†y qua</option>
                    <option value="month">Th√°ng n√†y</option>
                    <option value="quarter">Qu√Ω n√†y</option>
                    <option value="year">NƒÉm n√†y</option>
                  </select>
                </div>
                
                <div className="filter-group">
                  <label style={{ fontSize: '0.9rem', fontWeight: '600', color: '#333', marginRight: '8px' }}>
                    üè¢ B·ªô ph·∫≠n:
                  </label>
                  <select 
                    value={historyDepartmentFilter}
                    onChange={(e) => setHistoryDepartmentFilter(e.target.value)}
                    style={{
                      padding: '8px 12px',
                      borderRadius: '6px',
                      border: '1px solid #ddd',
                      fontSize: '0.9rem',
                      background: 'white'
                    }}
                  >
                    <option value="all">T·∫•t c·∫£</option>
                    {getHistoryDepartments().map(dept => (
                      <option key={dept} value={dept}>{dept}</option>
                    ))}
                  </select>
                </div>
                
                <div className="filter-group">
                  <label style={{ fontSize: '0.9rem', fontWeight: '600', color: '#333', marginRight: '8px' }}>
                    üìÖ Ng√†y c·ª• th·ªÉ:
                  </label>
                  <input 
                    type="date"
                    value={historyDateFilter}
                    onChange={(e) => {
                      setHistoryDateFilter(e.target.value);
                      if (e.target.value) {
                        setHistoryTimeFilter('all'); // Reset time filter when date is selected
                      }
                    }}
                    style={{
                      padding: '8px 12px',
                      borderRadius: '6px',
                      border: '1px solid #ddd',
                      fontSize: '0.9rem',
                      background: 'white'
                    }}
                  />
                  {historyDateFilter && (
                    <button 
                      onClick={() => setHistoryDateFilter('')}
                      style={{
                        marginLeft: '8px',
                        padding: '4px 8px',
                        borderRadius: '4px',
                        border: '1px solid #dc3545',
                        background: '#dc3545',
                        color: 'white',
                        fontSize: '0.8rem',
                        cursor: 'pointer'
                      }}
                    >
                      ‚úï X√≥a
                    </button>
                  )}
                </div>
                
                <div style={{ 
                  padding: '8px 12px', 
                  background: '#f8f9fa', 
                  borderRadius: '6px', 
                  fontSize: '0.9rem',
                  color: '#666',
                  border: '1px solid #e9ecef'
                }}>
                  üìä Hi·ªÉn th·ªã: {getFilteredHistory().length} / {evaluationHistory.length} ƒë√°nh gi√°
                  {currentUser?.role !== 'admin' && currentUser?.position !== 'Qu·∫£n l√Ω' && (
                    <span style={{ color: '#28a745', fontWeight: 'bold' }}> (B·ªô ph·∫≠n: {currentUser?.department})</span>
                  )}
                </div>
              </div>
            </div>
            
            {evaluationHistory.length === 0 ? (
              <div className="no-history">
                <p>Ch∆∞a c√≥ ƒë√°nh gi√° n√†o ƒë∆∞·ª£c l∆∞u</p>
              </div>
            ) : getFilteredHistory().length === 0 ? (
              <div className="no-history">
                <p>Kh√¥ng c√≥ ƒë√°nh gi√° n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc ƒë√£ ch·ªçn</p>
              </div>
            ) : (
              <div className="history-table-container">
                <div className="history-table">
                  <div className="table-header">
                    <div>üë§ Nh√¢n vi√™n</div>
                    <div>üè¢ B·ªô ph·∫≠n</div>
                    <div>üìÖ Ng√†y ƒë√°nh gi√°</div>
                    <div>üìä Hi·ªáu qu·∫£</div>
                    <div>‚öñÔ∏è K·ª∑ lu·∫≠t</div>
                    <div>ü§ù Th√°i ƒë·ªô</div>
                    <div>üéØ T·ªïng ƒëi·ªÉm</div>
                    <div>üèÜ X·∫øp lo·∫°i</div>
                    <div>üë®‚Äçüíº Ng∆∞·ªùi ƒë√°nh gi√°</div>
                    {(currentUser?.role === 'admin' || currentUser?.position === 'Qu·∫£n l√Ω') && (
                      <div>‚öôÔ∏è Thao t√°c</div>
                    )}
                  </div>
                  
                  {getFilteredHistory().map(evaluation => (
                    <div key={evaluation.id} className="table-row">
                      <div className="user-info">
                        <div className="user-name">{evaluation.userName}</div>
                      </div>
                      <div className="department">{evaluation.department}</div>
                      <div className="date">{new Date(evaluation.date).toLocaleDateString('vi-VN')}</div>
                      <div className="score performance" style={{ color: '#28a745' }}>
                        {evaluation.scores.performance}
                      </div>
                      <div className="score discipline" style={{ color: '#ffc107' }}>
                        {evaluation.scores.discipline}
                      </div>
                      <div className="score attitude" style={{ color: '#dc3545' }}>
                        {evaluation.scores.attitude}
                      </div>
                      <div className="total-score" style={{ color: '#6f42c1', fontWeight: 'bold' }}>
                        {evaluation.totalScore}
                      </div>
                      <div 
                        className="level"
                        style={{ 
                          color: getScoreLevel(evaluation.totalScore).color,
                          fontWeight: '600'
                        }}
                      >
                        {evaluation.level}
                      </div>
                      <div className="evaluator">
                        <div className="evaluator-name">
                          {evaluation.evaluatedBy || 'Ch∆∞a x√°c ƒë·ªãnh'}
                        </div>
                        <div className="evaluator-role">
                          {evaluation.evaluatorRole || 'Ch∆∞a x√°c ƒë·ªãnh'}
                        </div>
                      </div>
                      {(currentUser?.role === 'admin' || currentUser?.position === 'Qu·∫£n l√Ω') && (
                        <div className="actions">
                          <button 
                            className="delete-btn"
                            onClick={() => handleDeleteEvaluation(evaluation.id)}
                            title="X√≥a ƒë√°nh gi√°"
                            style={{
                              padding: '6px 12px',
                              borderRadius: '4px',
                              border: '1px solid #dc3545',
                              background: '#dc3545',
                              color: 'white',
                              fontSize: '0.8rem',
                              cursor: 'pointer',
                              transition: 'all 0.2s ease'
                            }}
                            onMouseOver={(e) => {
                              e.target.style.background = '#c82333';
                              e.target.style.borderColor = '#c82333';
                            }}
                            onMouseOut={(e) => {
                              e.target.style.background = '#dc3545';
                              e.target.style.borderColor = '#dc3545';
                            }}
                          >
                            üóëÔ∏è X√≥a
                          </button>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
         ) : viewMode === 'all-evaluations' ? (
          <div className="all-evaluations">
            <div className="all-evaluations-header">
              <div className="section-header">
                <h3>üë• T·∫•t c·∫£ ƒë√°nh gi√° KPI trong h·ªá th·ªëng</h3>
                <div style={{ display: 'flex', gap: '10px' }}>
                  <button 
                    className="export-excel-btn"
                    onClick={exportAllEvaluationsExcel}
                    title="Xu·∫•t danh s√°ch ƒë√°nh gi√° theo filter hi·ªán t·∫°i"
                  >
                    üìÑ Xu·∫•t theo filter
                  </button>
                  <button 
                    className="export-excel-btn"
                    onClick={exportAllEvaluationsExcelUnfiltered}
                    title="Xu·∫•t t·∫•t c·∫£ ƒë√°nh gi√° kh√¥ng b·ªã filter"
                    style={{ background: 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)' }}
                  >
                    üìã Xu·∫•t t·∫•t c·∫£
                  </button>
                  <button 
                    className="export-excel-btn"
                    onClick={() => {
                      const weeklySummaries = getFilteredWeeklySummaries();
                      if (weeklySummaries.length > 0) {
                        const filterSuffix = weeklyTimeFilter !== 'all' || weeklyDepartmentFilter !== 'all' 
                          ? `_${weeklyTimeFilter}_${weeklyDepartmentFilter}` 
                          : '';
                        exportWeeklySummariesToCSV(weeklySummaries, `Bao_cao_tong_hop_tuan${filterSuffix}`);
                      } else {
                        alert('üì≠ Ch∆∞a c√≥ ƒë√°nh gi√° n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc ƒë·ªÉ t·ªïng h·ª£p');
                      }
                    }}
                    title="Xu·∫•t b√°o c√°o t·ªïng h·ª£p tu·∫ßn theo b·ªô l·ªçc"
                    style={{ background: 'linear-gradient(135deg, #fd7e14 0%, #e8590c 100%)' }}
                  >
                    üìä T·ªïng h·ª£p tu·∫ßn
                  </button>
                </div>
              </div>
              <div className="evaluations-stats">
                <div className="stat-item">
                  <span className="stat-number">{allEvaluations.length}</span>
                  <span className="stat-label">T·ªïng ƒë√°nh gi√°</span>
                </div>
                <div className="stat-item">
                  <span className="stat-number">
                    {allEvaluations.filter(e => e.level === 'Xu·∫•t s·∫Øc').length}
                  </span>
                  <span className="stat-label">Xu·∫•t s·∫Øc</span>
                </div>
                <div className="stat-item">
                  <span className="stat-number">
                    {allEvaluations.filter(e => e.level === 'T·ªët').length}
                  </span>
                  <span className="stat-label">T·ªët</span>
                </div>
                <div className="stat-item">
                  <span className="stat-number">
                    {allEvaluations.filter(e => e.level === 'Trung b√¨nh').length}
                  </span>
                  <span className="stat-label">Trung b√¨nh</span>
                </div>
                <div className="stat-item">
                  <span className="stat-number">
                    {allEvaluations.filter(e => e.level === 'C·∫ßn c·∫£i thi·ªán').length}
                  </span>
                  <span className="stat-label">C·∫ßn c·∫£i thi·ªán</span>
                </div>
              </div>
            </div>

            <div className="evaluations-filters">
              <div className="filter-group">
                <label>üè¢ B·ªô ph·∫≠n:</label>
                <select 
                  value={selectedDepartment} 
                  onChange={(e) => setSelectedDepartment(e.target.value)}
                  className="filter-select"
                >
                  <option value="all">T·∫•t c·∫£ b·ªô ph·∫≠n</option>
                  {Array.from(new Set(allEvaluations.map(e => e.department))).map(dept => (
                    <option key={dept} value={dept}>{dept}</option>
                  ))}
                </select>
              </div>
              <div className="filter-group">
                <label>üìÖ Kho·∫£ng th·ªùi gian:</label>
                <select 
                  value={summaryPeriod} 
                  onChange={(e) => setSummaryPeriod(e.target.value)}
                  className="filter-select"
                >
                  <option value="week">Tu·∫ßn n√†y</option>
                  <option value="month">Th√°ng n√†y</option>
                  <option value="quarter">Qu√Ω n√†y</option>
                  <option value="year">NƒÉm n√†y</option>
                  <option value="all">T·∫•t c·∫£</option>
                </select>
              </div>
            </div>

            <div className="evaluations-table">
              <div className="table-header">
                <div>üë§ Nh√¢n vi√™n</div>
                <div>üè¢ B·ªô ph·∫≠n</div>
                <div>üìÖ Ng√†y ƒë√°nh gi√°</div>
                <div>üìä Hi·ªáu qu·∫£</div>
                <div>‚öñÔ∏è K·ª∑ lu·∫≠t</div>
                <div>ü§ù Th√°i ƒë·ªô</div>
                <div>üéØ T·ªïng ƒëi·ªÉm</div>
                <div>üèÜ X·∫øp lo·∫°i</div>
                <div>üë®‚Äçüíº Ng∆∞·ªùi ƒë√°nh gi√°</div>
                {(currentUser?.role === 'admin' || currentUser?.position === 'Qu·∫£n l√Ω') && (
                  <div>‚öôÔ∏è Thao t√°c</div>
                )}
              </div>
              
              <div className="filter-info" style={{ marginBottom: '15px', padding: '10px', background: '#f8f9fa', borderRadius: '8px', fontSize: '0.9rem' }}>
                üìä Hi·ªÉn th·ªã: {allEvaluations.filter(evaluation => {
                  // Qu·∫£n l√Ω xem t·∫•t c·∫£ ƒë√°nh gi√°, c√°c c·∫•p kh√°c ch·ªâ xem ƒë√°nh gi√° c·ªßa m√¨nh
                  if (currentUser?.role !== 'admin' && currentUser?.position !== 'Qu·∫£n l√Ω') {
                    if (evaluation.evaluatedBy !== currentUser.fullName) {
                      return false;
                    }
                  }
                  
                  if (selectedDepartment !== 'all' && evaluation.department !== selectedDepartment) {
                    return false;
                  }
                  const evalDate = new Date(evaluation.date);
                  const today = new Date();
                  let startDate;
                  
                  switch (summaryPeriod) {
                    case 'week':
                      // Current week: from Monday to Sunday
                      startDate = new Date(today);
                      startDate.setDate(today.getDate() - today.getDay() + 1); // Monday
                      const endDate = new Date(today);
                      endDate.setDate(today.getDate() - today.getDay() + 7); // Sunday
                      return evalDate >= startDate && evalDate <= endDate;
                    case 'month':
                      startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                      break;
                    case 'quarter':
                      const quarter = Math.floor(today.getMonth() / 3);
                      startDate = new Date(today.getFullYear(), quarter * 3, 1);
                      break;
                    case 'year':
                      startDate = new Date(today.getFullYear(), 0, 1);
                      break;
                    default:
                      return true;
                  }
                  return evalDate >= startDate && evalDate <= today;
                }).length} / {allEvaluations.length} ƒë√°nh gi√°
                {(currentUser?.role === 'admin' || currentUser?.position === 'Qu·∫£n l√Ω') && (
                  <span style={{ color: '#28a745', fontWeight: 'bold' }}> (Qu·∫£n l√Ω xem t·∫•t c·∫£)</span>
                )}
              </div>
              
              
              
              {(() => {
                const filteredEvaluations = allEvaluations
                  .filter(evaluation => {
                    // Qu·∫£n l√Ω xem t·∫•t c·∫£ ƒë√°nh gi√°, c√°c c·∫•p kh√°c ch·ªâ xem ƒë√°nh gi√° c·ªßa m√¨nh
                    if (currentUser?.role !== 'admin' && currentUser?.position !== 'Qu·∫£n l√Ω') {
                      if (evaluation.evaluatedBy !== currentUser.fullName) {
                        return false;
                      }
                    }
                    
                    // Filter by department
                    if (selectedDepartment !== 'all' && evaluation.department !== selectedDepartment) {
                      return false;
                    }
                    
                    // Filter by time period
                    const evalDate = new Date(evaluation.date);
                    const today = new Date();
                    let startDate;
                    
                    switch (summaryPeriod) {
                      case 'week':
                        // Current week: from Monday to Sunday
                        startDate = new Date(today);
                        startDate.setDate(today.getDate() - today.getDay() + 1); // Monday
                        const endDate = new Date(today);
                        endDate.setDate(today.getDate() - today.getDay() + 7); // Sunday
                        return evalDate >= startDate && evalDate <= endDate;
                      case 'month':
                        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                        break;
                      case 'quarter':
                        const quarter = Math.floor(today.getMonth() / 3);
                        startDate = new Date(today.getFullYear(), quarter * 3, 1);
                        break;
                      case 'year':
                        startDate = new Date(today.getFullYear(), 0, 1);
                        return evalDate >= startDate && evalDate <= today;
                      case 'all':
                        // Show all evaluations
                        return true;
                      default:
                        // Show all evaluations when no specific period is selected
                        return true;
                    }
                  })
                  .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Debug log
                console.log('Total evaluations:', allEvaluations.length);
                console.log('Filtered evaluations:', filteredEvaluations.length);
                console.log('Selected department:', selectedDepartment);
                console.log('Summary period:', summaryPeriod);
                
                return filteredEvaluations.map(evaluation => (
                  <div key={evaluation.id} className="evaluation-row">
                    <div className="user-info">
                      <div className="user-name">{evaluation.userName}</div>
                    </div>
                    <div className="department">{evaluation.department}</div>
                    <div className="date">
                      {new Date(evaluation.date).toLocaleDateString('vi-VN')}
                    </div>
                    <div className="score performance">
                      {evaluation.scores.performance}/100
                    </div>
                    <div className="score discipline">
                      {evaluation.scores.discipline}/100
                    </div>
                    <div className="score attitude">
                      {evaluation.scores.attitude}/100
                    </div>
                    <div className="total-score">
                      <strong>{evaluation.totalScore}/100</strong>
                    </div>
                    <div className="level">
                      <span 
                        className="level-badge"
                        style={{ 
                          backgroundColor: evaluation.level === 'Xu·∫•t s·∫Øc' ? '#28a745' :
                                         evaluation.level === 'T·ªët' ? '#17a2b8' :
                                         evaluation.level === 'Trung b√¨nh' ? '#ffc107' :
                                         '#dc3545'
                        }}
                      >
                        {evaluation.level}
                      </span>
                    </div>
                    <div className="evaluator">
                      <div className="evaluator-name">
                        {evaluation.evaluatedBy || 'Ch∆∞a x√°c ƒë·ªãnh'}
                      </div>
                      <div className="evaluator-role">
                        {evaluation.evaluatorRole || 'Ch∆∞a x√°c ƒë·ªãnh'}
                      </div>
                    </div>
                    {(currentUser?.role === 'admin' || currentUser?.position === 'Qu·∫£n l√Ω') && (
                      <div className="actions">
                        <button 
                          className="delete-btn"
                          onClick={() => handleDeleteEvaluation(evaluation.id)}
                          title="X√≥a ƒë√°nh gi√°"
                          style={{
                            padding: '6px 12px',
                            borderRadius: '4px',
                            border: '1px solid #dc3545',
                            background: '#dc3545',
                            color: 'white',
                            fontSize: '0.8rem',
                            cursor: 'pointer',
                            transition: 'all 0.2s ease'
                          }}
                          onMouseOver={(e) => {
                            e.target.style.background = '#c82333';
                            e.target.style.borderColor = '#c82333';
                          }}
                          onMouseOut={(e) => {
                            e.target.style.background = '#dc3545';
                            e.target.style.borderColor = '#dc3545';
                          }}
                        >
                          üóëÔ∏è X√≥a
                        </button>
                      </div>
                    )}
                  </div>
                ));
              })()}
            </div>

            {allEvaluations.length === 0 && (
              <div className="no-evaluations">
                <p>üì≠ Ch∆∞a c√≥ ƒë√°nh gi√° KPI n√†o trong h·ªá th·ªëng</p>
              </div>
            )}
          </div>
        ) : !isEvaluating ? (
          <div className="user-selection">
            <h3>üë• Ch·ªçn nh√¢n vi√™n ƒë·ªÉ ƒë√°nh gi√°</h3>
            
            {/* Th√¥ng tin quy·ªÅn ƒë√°nh gi√° */}
            <div className="evaluation-permission-info">
              {currentUser?.role === 'admin' || currentUser?.position === 'Qu·∫£n l√Ω' ? (
                <p>üìã <strong>Qu·∫£n l√Ω</strong> ƒë√°nh gi√° <strong>T·ªï tr∆∞·ªüng</strong></p>
              ) : currentUser?.position === 'T·ªï tr∆∞·ªüng' ? (
                <p>üìã <strong>T·ªï tr∆∞·ªüng</strong> ƒë√°nh gi√° <strong>T·ªï ph√≥</strong> v√† <strong>Nh√¢n vi√™n</strong> trong b·ªô ph·∫≠n <strong>{currentUser.department}</strong></p>
              ) : currentUser?.position === 'T·ªï ph√≥' ? (
                <p>üìã <strong>T·ªï ph√≥</strong> ƒë√°nh gi√° <strong>Nh√¢n vi√™n</strong> trong b·ªô ph·∫≠n <strong>{currentUser.department}</strong></p>
              ) : (
                <p>‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn ƒë√°nh gi√° KPI</p>
              )}
            </div>
            
            {/* Department Tabs */}
            {departments.length > 0 && (
              <div className="department-tabs">
                <button 
                  className={`dept-tab ${selectedDepartment === 'all' ? 'active' : ''}`}
                  onClick={() => setSelectedDepartment('all')}
                >
                  üè¢ T·∫•t c·∫£ b·ªô ph·∫≠n
                </button>
                {departments.map(dept => (
                  <button 
                    key={dept}
                    className={`dept-tab ${selectedDepartment === dept ? 'active' : ''}`}
                    onClick={() => setSelectedDepartment(dept)}
                  >
                    üè¢ {dept}
                  </button>
                ))}
              </div>
            )}

            {/* User Grid */}
            <div className="user-grid">
              {filteredUsers.length === 0 ? (
                <div className="no-users">
                  <p>Kh√¥ng c√≥ nh√¢n vi√™n n√†o trong b·ªô ph·∫≠n n√†y</p>
                </div>
              ) : (
                filteredUsers.map(user => {
                  // Ki·ªÉm tra xem ng∆∞·ªùi n√†y ƒë√£ ƒë∆∞·ª£c ƒë√°nh gi√° trong ng√†y h√¥m nay ch∆∞a
                  const today = new Date().toISOString().split('T')[0];
                  const alreadyEvaluatedToday = allEvaluations.some(evaluation => 
                    evaluation.userId === user.id && 
                    evaluation.date === today &&
                    evaluation.evaluatedBy === currentUser.fullName
                  );
                  
                  return (
                    <div key={user.id} className="user-card">
                      <div className="user-info">
                        <h4>{user.fullName}</h4>
                        <p>{user.department} - {user.position}</p>
                        {alreadyEvaluatedToday && (
                          <div className="evaluation-status">
                            <span className="status-badge evaluated">‚úÖ ƒê√£ ƒë√°nh gi√° h√¥m nay</span>
                          </div>
                        )}
                      </div>
                      <button 
                        onClick={() => handleStartEvaluation(user)}
                        className={`evaluate-btn ${alreadyEvaluatedToday ? 'disabled' : ''}`}
                        disabled={alreadyEvaluatedToday}
                        title={alreadyEvaluatedToday ? 'B·∫°n ƒë√£ ƒë√°nh gi√° ng∆∞·ªùi n√†y trong ng√†y h√¥m nay' : 'B·∫•m ƒë·ªÉ ƒë√°nh gi√° KPI'}
                      >
                        {alreadyEvaluatedToday ? '‚úÖ ƒê√£ ƒë√°nh gi√°' : 'üìù ƒê√°nh gi√° KPI'}
                      </button>
                    </div>
                  );
                })
              )}
            </div>
          </div>
        ) : (
          <div className="evaluation-form">
            <div className="evaluation-header">
              <h3>üìù ƒê√°nh gi√° KPI cho: {selectedUser.fullName}</h3>
              <div className="evaluation-date-display">
                <label htmlFor="evaluation-date">üìÖ Ng√†y ƒë√°nh gi√°:</label>
                <input
                  id="evaluation-date"
                  type="date"
                  value={evaluationDate}
                  onChange={(e) => setEvaluationDate(e.target.value)}
                  className="date-input"
                  max={new Date().toISOString().split('T')[0]}
                />
                <span className="date-note">üí° C√≥ th·ªÉ ch·ªçn ng√†y trong qu√° kh·ª© ƒë·ªÉ ƒë√°nh gi√° b√π</span>
              </div>
              <div className="evaluation-weights">
                <span>Thang ƒëi·ªÉm: 0-100 ƒëi·ªÉm cho m·ªói ti√™u ch√≠</span>
              </div>
            </div>

            <div className="criteria-list">
              {criteria.map(criterion => (
                <div key={criterion.name} className="criterion-card">
                  <div className="criterion-header">
                    <h4>{criterion.title} ({criterion.weight}%)</h4>
                    <p>{criterion.description}</p>
                  </div>
                  
                  <div className="evaluation-inputs">
                    <div className="evaluator-group">
                      <label>ƒêi·ªÉm ƒë√°nh gi√°: {evaluationData[criterion.name]}/100</label>
                      <input
                        type="range"
                        min="0"
                        max="100"
                        value={evaluationData[criterion.name]}
                        onChange={(e) => handleScoreChange(criterion.name, e.target.value)}
                        className="score-slider"
                      />
                      <div className="slider-labels">
                        <span>0</span>
                        <span>25</span>
                        <span>50</span>
                        <span>75</span>
                        <span>100</span>
                    </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>

            <div className="evaluation-summary">
              <div className="total-score">
                <h3>ƒêi·ªÉm t·ªïng KPI: {calculateTotalScore()}/100</h3>
                <div 
                  className="score-level"
                  style={{ color: getScoreLevel(calculateTotalScore()).color }}
                >
                  {getScoreLevel(calculateTotalScore()).level}
                </div>
              </div>
            </div>

            <div className="evaluation-actions">
              <button onClick={handleSaveEvaluation} className="save-evaluation-btn">
                üíæ L∆∞u ƒë√°nh gi√°
              </button>
              <button 
                onClick={() => setIsEvaluating(false)} 
                className="cancel-evaluation-btn"
              >
                ‚ùå H·ªßy
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Job Management Component
  const JobManagement = ({ jobs, onUpdateJobs, currentUser }) => {
    const [newJob, setNewJob] = useState({
      deliveryDate: '',
      department: currentUser?.department || '',
      description: '',
      completionTime: '',
      status: '',
      jobType: 'management',
      assignee: '',
      assigner: currentUser?.fullName || '',
      completionEvidence: [] // Array of uploaded files
    });
    const [isAdding, setIsAdding] = useState(false);
    const [filters, setFilters] = useState({
      department: '',
      status: '',
      search: '',
      timeRange: 'all' // all, week, month, quarter, year
    });
    const [uploadingFiles, setUploadingFiles] = useState({});
    const [showEvidenceModal, setShowEvidenceModal] = useState(false);
    const [selectedJob, setSelectedJob] = useState(null);

    // L·ªçc jobs theo b·ªô ph·∫≠n c·ªßa user (tr·ª´ admin)
    const getFilteredJobsByDepartment = () => {
      if (currentUser?.role === 'admin') {
        return jobs; // Admin th·∫•y t·∫•t c·∫£
      }
      
      // T·ªï tr∆∞·ªüng: ch·ªâ th·∫•y c√¥ng vi·ªác ƒë∆∞·ª£c giao cho m√¨nh ho·∫∑c b·ªô ph·∫≠n m√¨nh
      if (currentUser?.position === 'T·ªï tr∆∞·ªüng') {
        return jobs.filter(job => 
          job.department === currentUser?.department && 
          (job.assignee === currentUser?.fullName || !job.assignee)
        );
      }
      
      // T·ªï ph√≥ v√† nh√¢n vi√™n: ch·ªâ th·∫•y c√¥ng vi·ªác ƒë∆∞·ª£c giao cho m√¨nh ho·∫∑c b·ªô ph·∫≠n m√¨nh
      if (currentUser?.position === 'T·ªï ph√≥' || currentUser?.position === 'Nh√¢n vi√™n') {
        return jobs.filter(job => 
          job.department === currentUser?.department && 
          (job.assignee === currentUser?.fullName || !job.assignee)
        );
      }
      
      return jobs;
    };

    const departments = [
      'Kho Ph√¥i', 'S·∫£n Xu·∫•t', 'ƒê√≥ng g√≥i',
      'Kho & Tr·∫£i C·∫Øt', 'Qu·∫£n l√Ω'
    ];

    const statusOptions = ['nh·∫≠n vi·ªác', 'ƒëang x·ª≠ l√Ω', 'ch·ªù duy·ªát', 'th√†nh c√¥ng', 'th·∫•t b·∫°i'];

    // Filter jobs based on current filters (sau khi ƒë√£ l·ªçc theo b·ªô ph·∫≠n)
    const departmentFilteredJobs = getFilteredJobsByDepartment();
    
    // Filter by time range
    const getTimeFilteredJobs = (jobs) => {
      if (filters.timeRange === 'all') return jobs;
      
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      
      return jobs.filter(job => {
        if (!job.deliveryDate) return false;
        const jobDate = new Date(job.deliveryDate);
        const jobDateOnly = new Date(jobDate.getFullYear(), jobDate.getMonth(), jobDate.getDate());
        
        switch (filters.timeRange) {
          case 'week':
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            return jobDateOnly >= weekStart && jobDateOnly <= weekEnd;
            
          case 'month':
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            return jobDateOnly >= monthStart && jobDateOnly <= monthEnd;
            
          case 'quarter':
            const quarter = Math.floor(today.getMonth() / 3);
            const quarterStart = new Date(today.getFullYear(), quarter * 3, 1);
            const quarterEnd = new Date(today.getFullYear(), quarter * 3 + 3, 0);
            return jobDateOnly >= quarterStart && jobDateOnly <= quarterEnd;
            
          case 'year':
            const yearStart = new Date(today.getFullYear(), 0, 1);
            const yearEnd = new Date(today.getFullYear(), 11, 31);
            return jobDateOnly >= yearStart && jobDateOnly <= yearEnd;
            
          default:
            return true;
        }
      });
    };
    
    const timeFilteredJobs = getTimeFilteredJobs(departmentFilteredJobs);
    const filteredJobs = timeFilteredJobs.filter(job => {
      const matchesDepartment = !filters.department || job.department === filters.department;
      const matchesStatus = !filters.status || job.status === filters.status;
      const matchesSearch = !filters.search || 
        job.description.toLowerCase().includes(filters.search.toLowerCase()) ||
        job.department.toLowerCase().includes(filters.search.toLowerCase());
      
      return matchesDepartment && matchesStatus && matchesSearch;
    });

    const handleFilterChange = (filterType, value) => {
    setFilters(prev => ({
      ...prev,
        [filterType]: value
    }));
  };

  const clearFilters = () => {
    setFilters({
      department: '',
        status: '',
      search: '',
      timeRange: 'all'
    });
  };

  // File upload functions
  const handleFileUpload = async (jobId, files) => {
    const job = jobs.find(j => j.id === jobId);
    if (!job) {
      console.error('‚ùå Kh√¥ng t√¨m th·∫•y c√¥ng vi·ªác v·ªõi ID:', jobId);
      alert('‚ùå Kh√¥ng t√¨m th·∫•y c√¥ng vi·ªác. Vui l√≤ng th·ª≠ l·∫°i.');
      return;
    }

    if (!files || files.length === 0) {
      console.error('‚ùå Kh√¥ng c√≥ file n√†o ƒë∆∞·ª£c ch·ªçn');
      alert('‚ùå Vui l√≤ng ch·ªçn file ƒë·ªÉ upload.');
      return;
    }

    setUploadingFiles(prev => ({ ...prev, [jobId]: true }));

    try {
      console.log(`üì§ B·∫Øt ƒë·∫ßu upload ${files.length} file(s) cho c√¥ng vi·ªác ${jobId}`);
      
      // Test server connection first
      const serverOk = await testServerConnection();
      if (!serverOk) {
        throw new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra server c√≥ ƒëang ch·∫°y kh√¥ng.');
      }
      
      // Validate file types and sizes
      const maxFileSize = 50 * 1024 * 1024; // 50MB (ph√π h·ª£p v·ªõi server limit)
      const allowedTypes = [
        'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'image/bmp',
        'video/mp4', 'video/avi', 'video/mov', 'video/wmv', 'video/flv', 'video/webm', 'video/mkv'
      ];
      
      for (let file of files) {
        if (file.size > maxFileSize) {
          throw new Error(`File ${file.name} qu√° l·ªõn (t·ªëi ƒëa 50MB)`);
        }
        if (!allowedTypes.includes(file.type)) {
          throw new Error(`File ${file.name} kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£. Ch·ªâ ch·∫•p nh·∫≠n h√¨nh ·∫£nh v√† video.`);
        }
      }

      // Convert files to base64 for storage
      const filePromises = Array.from(files).map((file, index) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            console.log(`‚úÖ ƒê√£ ƒë·ªçc file ${index + 1}/${files.length}: ${file.name}`);
            resolve({
              name: file.name,
              type: file.type,
              size: file.size,
              data: reader.result,
              uploadDate: new Date().toISOString()
            });
          };
          reader.onerror = (error) => {
            console.error(`‚ùå L·ªói ƒë·ªçc file ${file.name}:`, error);
            reject(new Error(`L·ªói ƒë·ªçc file ${file.name}`));
          };
          reader.readAsDataURL(file);
        });
      });

      const uploadedFiles = await Promise.all(filePromises);
      console.log(`‚úÖ ƒê√£ convert ${uploadedFiles.length} file(s) th√†nh base64`);
      
      // Update job with new evidence
      const updatedJobs = jobs.map(j => 
        j.id === jobId 
          ? { 
              ...j, 
              completionEvidence: [...(j.completionEvidence || []), ...uploadedFiles],
              status: 'th√†nh c√¥ng' // Auto-complete when evidence is uploaded
            }
          : j
      );
      
      console.log('üíæ ƒêang l∆∞u d·ªØ li·ªáu v√†o server...');
      
      // Save to server
      const currentApiBase = window.API_BASE || API_BASE;
      const response = await fetch(`${currentApiBase}/api/jobs`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ jobs: updatedJobs }),
      });

      if (response.ok) {
        const result = await response.json();
        console.log('‚úÖ Server response:', result);
        onUpdateJobs(updatedJobs);
        alert(`‚úÖ ƒê√£ upload ${uploadedFiles.length} file(s) v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh "th√†nh c√¥ng"`);
      } else {
        const errorText = await response.text();
        console.error('‚ùå Server error response:', response.status, errorText);
        throw new Error(`Server tr·∫£ v·ªÅ l·ªói ${response.status}: ${errorText}`);
      }
      
    } catch (error) {
      console.error('‚ùå L·ªói upload file chi ti·∫øt:', error);
      alert(`‚ùå L·ªói khi upload file: ${error.message || 'Vui l√≤ng th·ª≠ l·∫°i.'}`);
    } finally {
      setUploadingFiles(prev => ({ ...prev, [jobId]: false }));
    }
  };

  const removeEvidence = async (jobId, evidenceIndex) => {
    try {
      const updatedJobs = jobs.map(job => 
        job.id === jobId 
          ? { 
              ...job, 
              completionEvidence: job.completionEvidence.filter((_, index) => index !== evidenceIndex)
            }
          : job
      );
      
      // Save to server
      const currentApiBase = window.API_BASE || API_BASE;
      const response = await fetch(`${currentApiBase}/api/jobs`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ jobs: updatedJobs }),
      });

      if (response.ok) {
        onUpdateJobs(updatedJobs);
        alert('‚úÖ ƒê√£ x√≥a b·∫±ng ch·ª©ng th√†nh c√¥ng');
      } else {
        throw new Error('L·ªói khi l∆∞u d·ªØ li·ªáu v√†o server');
      }
    } catch (error) {
      console.error('‚ùå L·ªói x√≥a b·∫±ng ch·ª©ng:', error);
      alert('‚ùå L·ªói khi x√≥a b·∫±ng ch·ª©ng. Vui l√≤ng th·ª≠ l·∫°i.');
    }
  };

  const openEvidenceModal = (job) => {
    setSelectedJob(job);
    setShowEvidenceModal(true);
  };


    const handleAddJob = async () => {
      if (!newJob.description || !newJob.deliveryDate || !newJob.assignee) {
        alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin');
        return;
      }

      try {
      const job = {
        id: Date.now(),
        ...newJob
      };

      const updatedJobs = [...jobs, job];
        
        // Save to server
        const response = await fetch(`${API_BASE}/api/jobs`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ jobs: updatedJobs }),
        });

        if (response.ok) {
      onUpdateJobs(updatedJobs);
          alert('‚úÖ ƒê√£ th√™m c√¥ng vi·ªác th√†nh c√¥ng');
      
      setNewJob({
        deliveryDate: '',
        department: currentUser?.department || '',
        description: '',
        completionTime: '',
        status: '',
            jobType: 'management',
            assignee: '',
            assigner: currentUser?.fullName || '',
            completionEvidence: []
      });
      setIsAdding(false);
        } else {
          throw new Error('L·ªói khi l∆∞u d·ªØ li·ªáu v√†o server');
        }
      } catch (error) {
        console.error('‚ùå L·ªói th√™m c√¥ng vi·ªác:', error);
        alert('‚ùå L·ªói khi th√™m c√¥ng vi·ªác. Vui l√≤ng th·ª≠ l·∫°i.');
      }
    };

    const handleDeleteJob = async (id) => {
      // Ch·ªâ Admin m·ªõi ƒë∆∞·ª£c x√≥a c√¥ng vi·ªác
      if (currentUser?.role !== 'admin') {
        alert('Ch·ªâ Qu·∫£n l√Ω m·ªõi c√≥ quy·ªÅn x√≥a c√¥ng vi·ªác!');
        return;
      }
      
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√¥ng vi·ªác n√†y?')) {
        try {
        const updatedJobs = jobs.filter(job => job.id !== id);
          
          // Save to server
          const response = await fetch(`${API_BASE}/api/jobs`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ jobs: updatedJobs }),
          });

          if (response.ok) {
        onUpdateJobs(updatedJobs);
            alert('‚úÖ ƒê√£ x√≥a c√¥ng vi·ªác th√†nh c√¥ng');
          } else {
            throw new Error('L·ªói khi l∆∞u d·ªØ li·ªáu v√†o server');
          }
        } catch (error) {
          console.error('‚ùå L·ªói x√≥a c√¥ng vi·ªác:', error);
          alert('‚ùå L·ªói khi x√≥a c√¥ng vi·ªác. Vui l√≤ng th·ª≠ l·∫°i.');
        }
      }
    };

    const handleUpdateJob = async (id, field, value) => {
      const job = jobs.find(j => j.id === id);
      
      // Kh√¥ng cho ph√©p ch·ªânh s·ª≠a c√¥ng vi·ªác ƒë√£ ho√†n th√†nh
      if (job && job.status === 'th√†nh c√¥ng') {
        alert('Kh√¥ng th·ªÉ ch·ªânh s·ª≠a c√¥ng vi·ªác ƒë√£ ho√†n th√†nh!');
        return;
      }
      
      // Ch·ªâ cho ph√©p thay ƒë·ªïi tr·∫°ng th√°i n·∫øu kh√¥ng ph·∫£i admin ho·∫∑c t·ªï tr∆∞·ªüng
      if (currentUser?.role !== 'admin' && currentUser?.position !== 'T·ªï tr∆∞·ªüng' && field !== 'status') {
        alert('B·∫°n ch·ªâ ƒë∆∞·ª£c ph√©p thay ƒë·ªïi tr·∫°ng th√°i c√¥ng vi·ªác!');
        return;
      }
      
      try {
      const updatedJobs = jobs.map(job => 
        job.id === id ? { ...job, [field]: value } : job
      );
        
        // Save to server
        const response = await fetch(`${API_BASE}/api/jobs`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ jobs: updatedJobs }),
        });

        if (response.ok) {
      onUpdateJobs(updatedJobs);
        } else {
          throw new Error('L·ªói khi l∆∞u d·ªØ li·ªáu v√†o server');
        }
      } catch (error) {
        console.error('‚ùå L·ªói c·∫≠p nh·∫≠t c√¥ng vi·ªác:', error);
        alert('‚ùå L·ªói khi c·∫≠p nh·∫≠t c√¥ng vi·ªác. Vui l√≤ng th·ª≠ l·∫°i.');
      }
    };

    return (
      <div className="job-management">
        <div className="job-header">
          <h2>üìã Qu·∫£n l√Ω c√¥ng vi·ªác</h2>
          <div className="header-actions">
            <button 
              onClick={testServerConnection}
              className="test-connection-btn"
              title="Ki·ªÉm tra k·∫øt n·ªëi server"
            >
              üîç Test Server
            </button>
            <button className="check-overdue-btn" onClick={checkAndUpdateOverdueJobs}>
              ‚ö†Ô∏è Ki·ªÉm tra tr·ªÖ h·∫°n
            </button>
            {(currentUser?.role === 'admin' || currentUser?.position === 'T·ªï tr∆∞·ªüng') && (
              <button 
                className="add-btn"
                onClick={() => setIsAdding(true)}
              >
                ‚ûï Th√™m c√¥ng vi·ªác
              </button>
            )}
          </div>
        </div>

        {/* Quick Time Filters */}
        <div className="quick-actions">
          <button 
            className={`quick-action-btn ${filters.timeRange === 'week' ? 'active' : ''}`}
            onClick={() => handleFilterChange('timeRange', 'week')}
          >
            üìÖ Tu·∫ßn n√†y
          </button>
          <button 
            className={`quick-action-btn ${filters.timeRange === 'month' ? 'active' : ''}`}
            onClick={() => handleFilterChange('timeRange', 'month')}
          >
            üìÜ Th√°ng n√†y
          </button>
          <button 
            className={`quick-action-btn ${filters.timeRange === 'quarter' ? 'active' : ''}`}
            onClick={() => handleFilterChange('timeRange', 'quarter')}
          >
            üìä Qu√Ω n√†y
          </button>
          <button 
            className={`quick-action-btn ${filters.timeRange === 'all' ? 'active' : ''}`}
            onClick={() => handleFilterChange('timeRange', 'all')}
          >
            üóìÔ∏è T·∫•t c·∫£
          </button>
        </div>

        {/* Filter Section */}
        <div className="filter-section">
          <div className="filter-row">
            <div className="filter-group">
              <label>üîç T√¨m ki·∫øm:</label>
              <input
                type="text"
                placeholder="Nh·∫≠p t·ª´ kh√≥a..."
                value={filters.search}
                onChange={(e) => handleFilterChange('search', e.target.value)}
                className="filter-input"
              />
            </div>
            
            <div className="filter-group">
              <label>üè¢ B·ªô ph·∫≠n:</label>
              <select
                value={filters.department}
                onChange={(e) => handleFilterChange('department', e.target.value)}
                className="filter-select"
              >
                <option value="">T·∫•t c·∫£ b·ªô ph·∫≠n</option>
                {departments.map(dept => (
                  <option key={dept} value={dept}>{dept}</option>
                ))}
              </select>
            </div>
            
            <div className="filter-group">
              <label>üìä Tr·∫°ng th√°i:</label>
              <select
                value={filters.status}
                onChange={(e) => handleFilterChange('status', e.target.value)}
                className="filter-select"
              >
                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                {statusOptions.map(status => (
                  <option key={status} value={status}>{status}</option>
                ))}
              </select>
            </div>
            
            <div className="filter-group">
              <label>üìÖ Th·ªùi gian:</label>
              <select
                value={filters.timeRange}
                onChange={(e) => handleFilterChange('timeRange', e.target.value)}
                className="filter-select"
              >
                <option value="all">T·∫•t c·∫£ th·ªùi gian</option>
                <option value="week">Tu·∫ßn n√†y</option>
                <option value="month">Th√°ng n√†y</option>
                <option value="quarter">Qu√Ω n√†y</option>
                <option value="year">NƒÉm n√†y</option>
              </select>
            </div>
            
            <div className="filter-actions">
              <button 
                onClick={clearFilters}
                className="clear-filters-btn"
              >
                üóëÔ∏è X√≥a b·ªô l·ªçc
              </button>
          <span className="filter-count">
            Hi·ªÉn th·ªã: {filteredJobs.length}/{timeFilteredJobs.length} c√¥ng vi·ªác
            {filters.timeRange !== 'all' && (
              <span className="time-info">
                {filters.timeRange === 'week' && ' (Tu·∫ßn n√†y)'}
                {filters.timeRange === 'month' && ' (Th√°ng n√†y)'}
                {filters.timeRange === 'quarter' && ' (Qu√Ω n√†y)'}
                {filters.timeRange === 'year' && ' (NƒÉm n√†y)'}
              </span>
            )}
            {currentUser?.role !== 'admin' && (
              <span className="department-info"> (B·ªô ph·∫≠n: {currentUser?.department})</span>
            )}
            {currentUser?.position === 'T·ªï ph√≥' || currentUser?.position === 'Nh√¢n vi√™n' ? (
              <span className="permission-info"> - Ch·ªâ th·∫•y c√¥ng vi·ªác ƒë∆∞·ª£c giao cho m√¨nh</span>
            ) : currentUser?.position === 'T·ªï tr∆∞·ªüng' ? (
              <span className="permission-info"> - Ch·ªâ th·∫•y c√¥ng vi·ªác ƒë∆∞·ª£c giao cho m√¨nh</span>
            ) : null}
          </span>
            </div>
          </div>
        </div>

        {isAdding && (
          <div className="add-job-form">
            <h3>Th√™m c√¥ng vi·ªác m·ªõi</h3>
            <div className="form-row">
              <input
                type="date"
                placeholder="Ng√†y giao vi·ªác"
                value={newJob.deliveryDate}
                onChange={(e) => setNewJob({...newJob, deliveryDate: e.target.value})}
              />
              <select
                value={newJob.department}
                onChange={(e) => setNewJob({...newJob, department: e.target.value})}
              >
                <option value="">Ch·ªçn b·ªô ph·∫≠n</option>
                {departments.map(dept => (
                  <option key={dept} value={dept}>{dept}</option>
                ))}
              </select>
            </div>
            <div className="form-row">
              <input
                type="text"
                placeholder="M√¥ t·∫£ c√¥ng vi·ªác"
                value={newJob.description}
                onChange={(e) => setNewJob({...newJob, description: e.target.value})}
              />
              <select
                value={newJob.assignee}
                onChange={(e) => setNewJob({...newJob, assignee: e.target.value})}
                className="job-select"
              >
                <option value="">Ch·ªçn ng∆∞·ªùi nh·∫≠n vi·ªác</option>
                {users.filter(user => user.department === newJob.department).map(user => (
                  <option key={user.id} value={user.fullName}>
                    {user.fullName} ({user.position})
                  </option>
                ))}
              </select>
            </div>
            <div className="form-row">
              <input
                type="date"
                placeholder="Th·ªùi gian ho√†n th√†nh"
                value={newJob.completionTime}
                onChange={(e) => setNewJob({...newJob, completionTime: e.target.value})}
              />
            </div>
            <div className="form-row">
              <select
                value={newJob.status}
                onChange={(e) => setNewJob({...newJob, status: e.target.value})}
              >
                <option value="">Ch·ªçn tr·∫°ng th√°i</option>
                {statusOptions.map(status => (
                  <option key={status} value={status}>{status}</option>
                ))}
              </select>
            </div>
            <div className="form-actions">
              <button onClick={handleAddJob} className="save-btn">
                üíæ L∆∞u
              </button>
              <button onClick={() => setIsAdding(false)} className="cancel-btn">
                ‚ùå H·ªßy
              </button>
            </div>
          </div>
        )}

        <div className="job-list">
          <div className="job-item header">
            <div>üìÖ Ng√†y giao</div>
            <div>üè¢ B·ªô ph·∫≠n</div>
            <div>üìù M√¥ t·∫£</div>
            <div>üë§ Ng∆∞·ªùi giao</div>
            <div>üéØ Ng∆∞·ªùi nh·∫≠n</div>
            <div>‚è∞ Th·ªùi gian</div>
            <div>üìä Tr·∫°ng th√°i</div>
            <div>üìé B·∫±ng ch·ª©ng</div>
            <div>‚öôÔ∏è Thao t√°c</div>
          </div>
          {filteredJobs.map(job => {
            const isCompleted = job.status === 'th√†nh c√¥ng';
            const canDelete = currentUser?.role === 'admin';
            const canEdit = currentUser?.role === 'admin' || currentUser?.position === 'T·ªï tr∆∞·ªüng';
            
            return (
              <div key={job.id} className={`job-item ${isCompleted ? 'completed' : ''}`}>
                <div data-label="Ng√†y giao">
                  <input
                    type="date"
                    value={job.deliveryDate}
                    onChange={(e) => handleUpdateJob(job.id, 'deliveryDate', e.target.value)}
                    className="job-input"
                    disabled={isCompleted || !canEdit}
                  />
                </div>
                <div data-label="B·ªô ph·∫≠n">
                  <select
                    value={job.department}
                    onChange={(e) => handleUpdateJob(job.id, 'department', e.target.value)}
                    className="job-select"
                    disabled={isCompleted || !canEdit}
                  >
                    {departments.map(dept => (
                      <option key={dept} value={dept}>{dept}</option>
                    ))}
                  </select>
                </div>
                <div data-label="M√¥ t·∫£">
                  <input
                    type="text"
                    value={job.description}
                    onChange={(e) => handleUpdateJob(job.id, 'description', e.target.value)}
                    className="job-input"
                    disabled={isCompleted || !canEdit}
                  />
                </div>
                <div data-label="Ng∆∞·ªùi giao">
                  <input
                    type="text"
                    value={job.assigner || ''}
                    onChange={(e) => handleUpdateJob(job.id, 'assigner', e.target.value)}
                    className="job-input"
                    disabled={isCompleted || !canEdit}
                    placeholder="Ng∆∞·ªùi giao vi·ªác"
                  />
                </div>
                <div data-label="Ng∆∞·ªùi nh·∫≠n">
                  <select
                    value={job.assignee || ''}
                    onChange={(e) => handleUpdateJob(job.id, 'assignee', e.target.value)}
                    className="job-select"
                    disabled={isCompleted || !canEdit}
                  >
                    <option value="">Ch·ªçn ng∆∞·ªùi nh·∫≠n vi·ªác</option>
                    {users.filter(user => user.department === job.department).map(user => (
                      <option key={user.id} value={user.fullName}>
                        {user.fullName} ({user.position})
                      </option>
                    ))}
                  </select>
                </div>
                <div data-label="Th·ªùi gian">
                  <input
                    type="date"
                    value={job.completionTime}
                    onChange={(e) => handleUpdateJob(job.id, 'completionTime', e.target.value)}
                    className="job-input"
                    disabled={isCompleted || !canEdit}
                  />
                </div>
                <div data-label="Tr·∫°ng th√°i">
                  <select
                    value={job.status}
                    onChange={(e) => handleUpdateJob(job.id, 'status', e.target.value)}
                    className="job-select"
                    disabled={isCompleted}
                  >
                    <option value="">Ch·ªçn tr·∫°ng th√°i</option>
                    {statusOptions.map(status => (
                      <option key={status} value={status}>
                        {status === 'nh·∫≠n vi·ªác' ? 'üìã Nh·∫≠n vi·ªác' :
                         status === 'ƒëang x·ª≠ l√Ω' ? '‚è≥ ƒêang x·ª≠ l√Ω' :
                         status === 'ch·ªù duy·ªát' ? '‚è∏Ô∏è Ch·ªù duy·ªát' :
                         status === 'th√†nh c√¥ng' ? '‚úÖ Th√†nh c√¥ng' :
                         status === 'th·∫•t b·∫°i' ? '‚ùå Th·∫•t b·∫°i' : status}
                      </option>
                    ))}
                  </select>
                </div>
                <div data-label="B·∫±ng ch·ª©ng">
                  <div className="evidence-section">
                    {job.completionEvidence && job.completionEvidence.length > 0 ? (
                      <div className="evidence-preview">
                        <span className="evidence-count">
                          üìé {job.completionEvidence.length} file(s)
                        </span>
                        <button 
                          className="view-evidence-btn"
                          onClick={() => openEvidenceModal(job)}
                          title="Xem b·∫±ng ch·ª©ng"
                        >
                          üëÅÔ∏è
                        </button>
                      </div>
                    ) : (
                      <div className="upload-section">
                        <input
                          type="file"
                          id={`upload-${job.id}`}
                          multiple
                          accept="image/*,video/*"
                          onChange={(e) => handleFileUpload(job.id, e.target.files)}
                          className="file-input"
                          disabled={uploadingFiles[job.id]}
                          title="Ch·ªçn h√¨nh ·∫£nh ho·∫∑c video (t·ªëi ƒëa 50MB m·ªói file)"
                        />
                        <label 
                          htmlFor={`upload-${job.id}`}
                          className={`upload-btn ${uploadingFiles[job.id] ? 'uploading' : ''}`}
                        >
                          {uploadingFiles[job.id] ? '‚è≥ Uploading...' : 'üì§ Upload'}
                        </label>
                      </div>
                    )}
                  </div>
                </div>
                <div data-label="Thao t√°c">
                  {canDelete ? (
                    <button 
                      onClick={() => handleDeleteJob(job.id)}
                      className="delete-btn"
                    >
                      üóëÔ∏è X√≥a
                    </button>
                  ) : (
                    <span className="no-permission">‚ùå Kh√¥ng c√≥ quy·ªÅn</span>
                  )}
                </div>
              </div>
            );
          })}
      </div>

      {/* Evidence Modal */}
      {showEvidenceModal && selectedJob && (
        <div className="modal-overlay" onClick={() => setShowEvidenceModal(false)}>
          <div className="modal-content evidence-modal" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <h3>üìé B·∫±ng ch·ª©ng ho√†n th√†nh: {selectedJob.description}</h3>
              <button 
                className="close-btn"
                onClick={() => setShowEvidenceModal(false)}
              >
                ‚ùå
              </button>
            </div>
            
            <div className="modal-body">
              <div className="job-info">
                <p><strong>B·ªô ph·∫≠n:</strong> {selectedJob.department}</p>
                <p><strong>Ng∆∞·ªùi th·ª±c hi·ªán:</strong> {selectedJob.assignee}</p>
                <p><strong>Ng√†y giao:</strong> {new Date(selectedJob.deliveryDate).toLocaleDateString('vi-VN')}</p>
                <p><strong>H·∫°n ho√†n th√†nh:</strong> {selectedJob.completionTime}</p>
              </div>
              
              <div className="evidence-gallery">
                {selectedJob.completionEvidence && selectedJob.completionEvidence.length > 0 ? (
                  selectedJob.completionEvidence.map((evidence, index) => (
                    <div key={index} className="evidence-item">
                      <div className="evidence-header">
                        <span className="evidence-name">{evidence.name}</span>
                        <div className="evidence-actions">
                          <span className="evidence-size">
                            {(evidence.size / 1024 / 1024).toFixed(2)} MB
                          </span>
                          <button 
                            className="remove-evidence-btn"
                            onClick={() => removeEvidence(selectedJob.id, index)}
                            title="X√≥a file"
                          >
                            üóëÔ∏è
                          </button>
                        </div>
                      </div>
                      
                      <div className="evidence-preview">
                        {evidence.type.startsWith('image/') ? (
                          <img 
                            src={evidence.data} 
                            alt={evidence.name}
                            className="evidence-image"
                            onClick={() => window.open(evidence.data, '_blank')}
                          />
                        ) : evidence.type.startsWith('video/') ? (
                          <video 
                            src={evidence.data}
                            controls
                            className="evidence-video"
                          >
                            Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ video
                          </video>
                        ) : (
                          <div className="evidence-file">
                            <div className="file-icon">üìÑ</div>
                            <div className="file-name">{evidence.name}</div>
                            <a 
                              href={evidence.data} 
                              download={evidence.name}
                              className="download-btn"
                            >
                              üì• T·∫£i xu·ªëng
                            </a>
                          </div>
                        )}
                      </div>
                      
                      <div className="evidence-meta">
                        <span className="upload-date">
                          üìÖ {new Date(evidence.uploadDate).toLocaleString('vi-VN')}
                        </span>
                      </div>
                    </div>
                  ))
                ) : (
                  <div className="no-evidence">
                    <p>üì≠ Ch∆∞a c√≥ b·∫±ng ch·ª©ng n√†o ƒë∆∞·ª£c upload</p>
                  </div>
                )}
              </div>
              
              <div className="modal-actions">
                <input
                  type="file"
                  id="modal-upload"
                  multiple
                  accept="image/*,video/*"
                  onChange={(e) => {
                    handleFileUpload(selectedJob.id, e.target.files);
                    e.target.value = ''; // Reset input
                  }}
                  className="file-input"
                  disabled={uploadingFiles[selectedJob.id]}
                  title="Ch·ªçn h√¨nh ·∫£nh ho·∫∑c video (t·ªëi ƒëa 50MB m·ªói file)"
                />
                <label 
                  htmlFor="modal-upload"
                  className={`upload-btn modal-upload-btn ${uploadingFiles[selectedJob.id] ? 'uploading' : ''}`}
                >
                  {uploadingFiles[selectedJob.id] ? '‚è≥ ƒêang upload...' : 'üì§ Th√™m b·∫±ng ch·ª©ng'}
                </label>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
  };

  // User Management Component
  const UserManagement = ({ users, onUpdateUsers, currentUser }) => {
    const [newUser, setNewUser] = useState({
      username: '',
      password: '',
      fullName: '',
      department: currentUser?.department || '',
      position: '',
      role: 'user'
    });
    const [isAdding, setIsAdding] = useState(false);
    const [editingUser, setEditingUser] = useState(null);
    const [editUser, setEditUser] = useState({
      username: '',
      password: '',
      fullName: '',
      department: '',
      position: '',
      role: 'user'
    });
    const [searchTerm, setSearchTerm] = useState('');
    const [departmentFilter, setDepartmentFilter] = useState('');
    const [showPasswords, setShowPasswords] = useState({});

    // L·ªçc users theo b·ªô ph·∫≠n c·ªßa user (tr·ª´ admin)
    const getFilteredUsersByDepartment = () => {
      if (currentUser?.role === 'admin') {
        return users; // Admin th·∫•y t·∫•t c·∫£
      }
      return users.filter(user => user.department === currentUser?.department);
    };

    const departments = [
      'Kho Ph√¥i', 'S·∫£n Xu·∫•t', 'ƒê√≥ng g√≥i',
      'Kho & Tr·∫£i C·∫Øt', 'Qu·∫£n l√Ω'
    ];

    const positions = ['Qu·∫£n l√Ω', 'T·ªï tr∆∞·ªüng', 'T·ªï ph√≥', 'Nh√¢n vi√™n'];

    // Filter users based on search and department (sau khi ƒë√£ l·ªçc theo b·ªô ph·∫≠n)
    const departmentFilteredUsers = getFilteredUsersByDepartment();
    const filteredUsers = departmentFilteredUsers.filter(user => {
      const matchesSearch = !searchTerm || 
        user.fullName.toLowerCase().includes(searchTerm.toLowerCase()) ||
        user.username.toLowerCase().includes(searchTerm.toLowerCase()) ||
        user.department.toLowerCase().includes(searchTerm.toLowerCase());
      
      const matchesDepartment = !departmentFilter || user.department === departmentFilter;
      
      return matchesSearch && matchesDepartment;
    });

    const totalUsers = departmentFilteredUsers.length;
    const filteredCount = filteredUsers.length;

    const togglePasswordVisibility = (userId) => {
      setShowPasswords(prev => ({
        ...prev,
        [userId]: !prev[userId]
      }));
    };

    const handleAddUser = () => {
      if (!newUser.username || !newUser.password || !newUser.fullName) {
        alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin');
        return;
      }

      const user = {
        id: Date.now(),
        ...newUser
      };

      const updatedUsers = [...users, user];
      onUpdateUsers(updatedUsers);
      
      setNewUser({
        username: '',
        password: '',
        fullName: '',
        department: '',
        position: '',
        role: 'user'
      });
      setIsAdding(false);
    };

    const handleDeleteUser = (id) => {
      if (id === currentUser.id) {
        alert('Kh√¥ng th·ªÉ x√≥a t√†i kho·∫£n ƒëang ƒëƒÉng nh·∫≠p');
        return;
      }
      
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y?')) {
        const updatedUsers = users.filter(user => user.id !== id);
        onUpdateUsers(updatedUsers);
      }
    };

    const handleEditUser = (user) => {
      setEditingUser(user.id);
      setEditUser({
        username: user.username,
        password: user.password,
        fullName: user.fullName,
        department: user.department,
        position: user.position,
        role: user.role
      });
    };

    const handleSaveEdit = () => {
      if (!editUser.username || !editUser.fullName) {
        alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin');
        return;
      }

      const updatedUsers = users.map(user => 
        user.id === editingUser ? { ...user, ...editUser } : user
      );
      onUpdateUsers(updatedUsers);
      setEditingUser(null);
      setEditUser({
        username: '',
        password: '',
        fullName: '',
        department: '',
        position: '',
        role: 'user'
      });
    };

    const handleCancelEdit = () => {
      setEditingUser(null);
      setEditUser({
        username: '',
        password: '',
        fullName: '',
        department: '',
        position: '',
        role: 'user'
      });
    };

  return (
      <div className="user-management">
        <div className="user-header">
            <div className="header-info">
            <h2>üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h2>
            <div className="user-stats">
              <span className="total-users">T·ªïng: {totalUsers} ng∆∞·ªùi d√πng</span>
              <span className="filtered-users">Hi·ªÉn th·ªã: {filteredCount}/{totalUsers}</span>
              {currentUser?.role !== 'admin' && (
                <span className="department-info"> (B·ªô ph·∫≠n: {currentUser?.department})</span>
              )}
            </div>
              </div>
          {(currentUser?.role === 'admin' || currentUser?.position === 'T·ªï tr∆∞·ªüng') && (
            <button 
              className="add-btn"
              onClick={() => setIsAdding(true)}
            >
              ‚ûï Th√™m ng∆∞·ªùi d√πng
            </button>
          )}
            </div>

        <div className="user-filters">
          <div className="filter-group">
            <label>üîç T√¨m ki·∫øm:</label>
            <input
              type="text"
              placeholder="Nh·∫≠p t√™n, username ho·∫∑c b·ªô ph·∫≠n..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="search-input"
            />
            </div>
          
          <div className="filter-group">
            <label>üè¢ B·ªô ph·∫≠n:</label>
            <select
              value={departmentFilter}
              onChange={(e) => setDepartmentFilter(e.target.value)}
              className="department-select"
            >
              <option value="">T·∫•t c·∫£ b·ªô ph·∫≠n</option>
              {departments.map(dept => (
                <option key={dept} value={dept}>{dept}</option>
              ))}
            </select>
          </div>

          <div className="filter-actions">
          <button 
              onClick={() => {
                setSearchTerm('');
                setDepartmentFilter('');
              }}
              className="clear-filters-btn"
            >
              üóëÔ∏è X√≥a b·ªô l·ªçc
          </button>
          </div>
        </div>

        {isAdding && (
          <div className="add-user-form">
            <h3>Th√™m ng∆∞·ªùi d√πng m·ªõi</h3>
            <div className="form-row">
              <input
                type="text"
                placeholder="T√™n ƒëƒÉng nh·∫≠p"
                value={newUser.username}
                onChange={(e) => setNewUser({...newUser, username: e.target.value})}
              />
              <input
                type="password"
                placeholder="M·∫≠t kh·∫©u"
                value={newUser.password}
                onChange={(e) => setNewUser({...newUser, password: e.target.value})}
              />
            </div>
            <div className="form-row">
              <input
                type="text"
                placeholder="H·ªç t√™n"
                value={newUser.fullName}
                onChange={(e) => setNewUser({...newUser, fullName: e.target.value})}
              />
              <select
                value={newUser.department}
                onChange={(e) => setNewUser({...newUser, department: e.target.value})}
              >
                <option value="">Ch·ªçn b·ªô ph·∫≠n</option>
                {departments.map(dept => (
                  <option key={dept} value={dept}>{dept}</option>
                ))}
              </select>
            </div>
            <div className="form-row">
              <select
                value={newUser.position}
                onChange={(e) => setNewUser({...newUser, position: e.target.value})}
              >
                <option value="">Ch·ªçn v·ªã tr√≠</option>
                {positions.map(pos => (
                  <option key={pos} value={pos}>{pos}</option>
                ))}
              </select>
              <select
                value={newUser.role}
                onChange={(e) => setNewUser({...newUser, role: e.target.value})}
              >
                <option value="user">Ng∆∞·ªùi d√πng</option>
                <option value="admin">Qu·∫£n tr·ªã vi√™n</option>
              </select>
            </div>
            <div className="form-actions">
              <button onClick={handleAddUser} className="save-btn">
                üíæ L∆∞u
            </button>
              <button onClick={() => setIsAdding(false)} className="cancel-btn">
                ‚ùå H·ªßy
              </button>
            </div>
          </div>
        )}

        <div className="user-list">
          <div className="user-item header">
            <div>H·ªç t√™n</div>
            <div>T√™n ƒëƒÉng nh·∫≠p</div>
            <div>M·∫≠t kh·∫©u</div>
            <div>B·ªô ph·∫≠n</div>
            <div>V·ªã tr√≠</div>
            <div>Quy·ªÅn</div>
            <div>Thao t√°c</div>
          </div>
          {filteredUsers.map(user => (
            <div key={user.id} className="user-item">
              {editingUser === user.id ? (
                <>
                  <div data-label="H·ªç t√™n">
                    <input
                      type="text"
                      value={editUser.fullName}
                      onChange={(e) => setEditUser({...editUser, fullName: e.target.value})}
                      className="edit-input"
                    />
                  </div>
                  <div data-label="T√™n ƒëƒÉng nh·∫≠p">
                    <input
                      type="text"
                      value={editUser.username}
                      onChange={(e) => setEditUser({...editUser, username: e.target.value})}
                      className="edit-input"
                    />
                  </div>
                  <div data-label="M·∫≠t kh·∫©u">
                    <input
                      type="password"
                      value={editUser.password}
                      onChange={(e) => setEditUser({...editUser, password: e.target.value})}
                      className="edit-input"
                      placeholder="M·∫≠t kh·∫©u m·ªõi"
                    />
                  </div>
                  <div data-label="B·ªô ph·∫≠n">
                    <select
                      value={editUser.department}
                      onChange={(e) => setEditUser({...editUser, department: e.target.value})}
                      className="edit-select"
                    >
                      <option value="">Ch·ªçn b·ªô ph·∫≠n</option>
                      {departments.map(dept => (
                        <option key={dept} value={dept}>{dept}</option>
                      ))}
                    </select>
                  </div>
                  <div data-label="V·ªã tr√≠">
                    <select
                      value={editUser.position}
                      onChange={(e) => setEditUser({...editUser, position: e.target.value})}
                      className="edit-select"
                    >
                      <option value="">Ch·ªçn v·ªã tr√≠</option>
                      {positions.map(pos => (
                        <option key={pos} value={pos}>{pos}</option>
                      ))}
                    </select>
                  </div>
                  <div data-label="Quy·ªÅn">
                    <select
                      value={editUser.role}
                      onChange={(e) => setEditUser({...editUser, role: e.target.value})}
                      className="edit-select"
                    >
                      <option value="user">Ng∆∞·ªùi d√πng</option>
                      <option value="admin">Qu·∫£n tr·ªã vi√™n</option>
                    </select>
                  </div>
                  <div data-label="Thao t√°c">
                    <button onClick={handleSaveEdit} className="save-btn">
                      üíæ L∆∞u
                    </button>
                    <button onClick={handleCancelEdit} className="cancel-btn">
                      ‚ùå H·ªßy
                    </button>
                  </div>
                </>
              ) : (
                <>
                  <div data-label="H·ªç t√™n">{user.fullName}</div>
                  <div data-label="T√™n ƒëƒÉng nh·∫≠p">{user.username}</div>
                  <div data-label="M·∫≠t kh·∫©u" className="password-display">
                    <span className="password-text">
                      {showPasswords[user.id] ? user.password : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}
                    </span>
                    <button 
                      className="password-toggle-btn"
                      onClick={() => togglePasswordVisibility(user.id)}
                      title={showPasswords[user.id] ? '·∫®n m·∫≠t kh·∫©u' : 'Hi·ªán m·∫≠t kh·∫©u'}
                    >
                      {showPasswords[user.id] ? 'üôà' : 'üëÅÔ∏è'}
                    </button>
                  </div>
                  <div data-label="B·ªô ph·∫≠n">{user.department}</div>
                  <div data-label="V·ªã tr√≠">{user.position}</div>
                  <div data-label="Quy·ªÅn">{user.role === 'admin' ? 'Qu·∫£n tr·ªã' : 'Ng∆∞·ªùi d√πng'}</div>
                  <div data-label="Thao t√°c">
                    {(currentUser?.role === 'admin' || currentUser?.position === 'T·ªï tr∆∞·ªüng') && (
                      <>
                        <button 
                          onClick={() => handleEditUser(user)}
                          className="edit-btn"
                        >
                          ‚úèÔ∏è S·ª≠a
                        </button>
                        <button 
                          onClick={() => handleDeleteUser(user.id)}
                          className="delete-btn"
                          disabled={user.id === currentUser.id}
                        >
                          üóëÔ∏è X√≥a
                        </button>
                      </>
                    )}
                  </div>
                </>
              )}
            </div>
          ))}
      </div>
    </div>
  );
  };

  // Render
  if (!isAuthenticated) {
    return <LoginForm />;
}

  return <MainApp />;
}

export default App;